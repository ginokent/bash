#!/usr/bin/env bash
set -E -o pipefail
cat >/dev/null <<'# djeeno.github.io'
<link rel="icon" href="/favicon.ico" type="image/x-icon"><style>body{font-size:0;margin:0}code{font-size:1rem;font-family:Osaka,Menlo,Monaco,Consolas,'Courier New','Andale Mono','Ubuntu Mono',monospace}</style><pre><code>##
# djeeno.github.io
##

# Run the following command to execute this script:
#   $ curl https://djeeno.github.io/docker/ | bash

export HTTP_CLIENT; HTTP_CLIENT="$( { command -v curl 1>/dev/null && printf "curl -LSs "; } || { command -v wget 1>/dev/null && printf "wget -qO- "; } )"
[ "${HTTP_CLIENT:?"curl or wget are required to run this script"}" ] || exit 1
# shellcheck disable=SC2154
[ "${envIsLoaded}" = true ] || eval "$(${HTTP_CLIENT} https://djeeno.github.io/common/)" || exit 1

##
# https://hub.docker.com/r/djeeno/ubuntu
# $ docker pull djeeno/ubuntu:18.04
##
docker_djeeno_ubuntu_1804 () { (
  set -E -o pipefail
  echo "${FUNCNAME[0]} を実行します。" | stderrPipeInfo
  command -v docker 1>/dev/null || { echo "docker がインストールされている必要があります。" | stderrPipeError; return 1; }
  TMPDIR="/tmp/${FUNCNAME[0]}"
  trap 'rm -rf "${TMPDIR:?}"' EXIT
  rm -rf "${TMPDIR:?}"
  mkdir -p "${TMPDIR:?}"
  cd "${TMPDIR:?}"
  
  DOCKER_REPOSITORY=djeeno/ubuntu
  DOCKER_TAG=${DOCKER_REPOSITORY}:18.04
  
  cat <<"EOF" >Dockerfile
FROM ubuntu:18.04

LABEL maintainer="djeeno <djeeno@localhost>"

# locale
RUN set -x \
  && apt-get update \
  && apt-get install -y locales \
  && localedef -f UTF-8 -i ja_JP ja_JP.UTF-8 \
  && set +x

# git
RUN set -x \
  && bash -cx 'apt-get update && apt-get install -y lib{curl4-gnutls,expat1,ssl,z}-dev gcc gettext less make tar wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version' \
  && curl -fLRSs https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash -o ~/.git-completion.bash \
  && curl -fLRSs https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh \
  && echo 'test -f ~/.git-completion.bash && source "$_"' >> ~/.bashrc \
  && echo 'test -f ~/.git-prompt.sh && source "$_"' >> ~/.bashrc \
  && set +x

# common
RUN set -x \
  && apt-get install -y bash-completion curl sudo vim wget \
  && set +x

ENV LANG="ja_JP.UTF-8" LANGUAGE="ja_JP:ja" LC_ALL="ja_JP.UTF-8" PATH="/usr/local/bin:$PATH"
EOF
  echo 'docker build を実行します。' | stderrPipeInfo
  docker build --tag ${DOCKER_TAG} .
  
  echo 'docker run をテスト実行します。' | stderrPipeInfo
  docker run --rm --name test_djeeno_ubuntu_1804 ${DOCKER_TAG} date
  
  echo "docker push ${DOCKER_TAG} を実行します。 (事前に \"docker login\" を実行する必要があります)" | stderrPipeInfo
  docker push ${DOCKER_TAG}
  
  echo "docker push ${DOCKER_REPOSITORY}:latest を実行します。 (事前に \"docker login\" を実行する必要があります)" | stderrPipeInfo
  docker tag ${DOCKER_TAG} ${DOCKER_REPOSITORY}:latest
  docker push ${DOCKER_REPOSITORY}:latest
  
  echo "正常に実行が完了しました。" | stderrPipeOK
)} && docker_djeeno_ubuntu_1804

##
# https://hub.docker.com/r/djeeno/awscli
# $ docker pull djeeno/awscli:latest
##
docker_djeeno_awscli() { (
  set -E -o pipefail
  echo "${FUNCNAME[0]} を実行します。" | stderrPipeInfo
  command -v docker 1>/dev/null || { echo "docker がインストールされている必要があります。" | stderrPipeError; return 1; }
  TMPDIR="/tmp/${FUNCNAME[0]}"
  trap 'rm -rf "${TMPDIR:?}"' EXIT
  rm -rf "${TMPDIR:?}"
  mkdir -p "${TMPDIR:?}"
  cd "${TMPDIR:?}"
  
  VERSION=1.17.12
  DOCKER_REPOSITORY=djeeno/awscli
  DOCKER_TAG="${DOCKER_REPOSITORY}:${VERSION}"
  
  cat <<EOF >Dockerfile
FROM python:3.8.1

LABEL maintainer="djeeno <djeeno@localhost>"

RUN set -x \
  && apt-get update \
  && apt-get install -y groff-base less \
  && set +x

RUN set -x
  && pip install awscli==${VERSION} \
  && set +x
EOF
  echo 'docker build を実行します。' | stderrPipeInfo
  docker build --tag "${DOCKER_TAG}" .
  
  echo 'docker run をテスト実行します。' | stderrPipeInfo
  docker run --rm --name "test_${FUNCNAME[0]}" "${DOCKER_TAG}" date
  
  echo "docker push ${DOCKER_TAG} を実行します。 (事前に \"docker login\" を実行する必要があります)" | stderrPipeInfo
  docker push "${DOCKER_TAG}"
  
  echo "docker push ${DOCKER_REPOSITORY}:latest を実行します。 (事前に \"docker login\" を実行する必要があります)" | stderrPipeInfo
  docker tag "${DOCKER_TAG}" "${DOCKER_REPOSITORY}:latest"
  docker push "${DOCKER_REPOSITORY}:latest"
  
  echo "正常に実行が完了しました。" | stderrPipeOK
)} && docker_djeeno_awscli



# (C) 2018 djeeno </code></pre></div>
