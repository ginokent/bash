#!/usr/bin/env bash
# shellcheck disable=SC1090
cat >/dev/null << '#sh.djeeno.com'
<link rel="icon" href="/favicon.ico" type="image/x-icon"><style>body{font-size:0;margin:0}pre{font-size:1rem;font-family:'Ricty Diminished',Osaka,Menlo,Monaco,Consolas,'Courier New','Andale Mono','Ubuntu Mono',monospace}</style><pre><code>##
#sh.djeeno.com
##



# shellcheck disable=SC2089,SC2090
stderrPipeDebug=" exec awk \"{print \\\"\\\\033[00m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [  debug] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeDebug
# shellcheck disable=SC2089,SC2090
stderrPipeNotice="exec awk \"{print \\\"\\\\033[01m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [ notice] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeNotice
# shellcheck disable=SC2089,SC2090
stderrPipeError=" exec awk \"{print \\\"\\\\033[31m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [  error] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeError
# shellcheck disable=SC2089,SC2090
stderrPipeOK="    exec awk \"{print \\\"\\\\033[32m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [     ok] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeOK
# shellcheck disable=SC2089,SC2090
stderrPipeWarn="  exec awk \"{print \\\"\\\\033[33m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [warning] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeWarn
# shellcheck disable=SC2089,SC2090
stderrPipeInfo="  exec awk \"{print \\\"\\\\033[34m\\\$(date +%Y-%m-%dT%H:%M:%S%z) [   info] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin 1>&2" && export stderrPipeInfo



cat << "DOCUMENT" | sh -c "${stderrPipeNotice:?}"
+--!!注意!!----------------------------------------------------------------------------+
| このページをシェルスクリプトとして実行しないでください。                             |
| この index.html はシェルスクリプトとして実行されることを想定して作成されていません。 |
+--------------------------------------------------------------------------------------+

個人用コマンドチートシート。

  curl -LRsS https://djeeno.github.io/sh/

や

  _readline_helpme() {
    command -v peco 1>/dev/null || bash -c "$(curl -LRsS https://djeeno.github.io/sh/peco/)"
    READLINE_LINE=$(curl -LRsS https://djeeno.github.io/sh/ | cat -n | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | peco --layout bottom-up | sed 's/^[^0-9]*[0-9]*[^0-9]//')
    READLINE_POINT=${#READLINE_LINE}
  } && bind -x '"\C-n":_readline_helpme'

的に参照されることを期待しています。

(C) 2018 djeeno
DOCUMENT
exit 0

# ====================================================================================================
#   ここから
# ====================================================================================================

# ==================================================
# 共通
# ==================================================

# 一撃インストール系
xcode-select --install
bash -c "$(curl -LRsS https://djeeno.github.io/sh/brew/)"
bash -c "command -v gcloud || curl -LRsS https://sdk.cloud.google.com/ | bash"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/git/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/asdf/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/asdf/golang/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/asdf/kubectl/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/asdf/kubetail/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/direnv/)"
bash -c "$(curl -LRsS https://djeeno.github.io/sh/peco/)"
bash -c "uname -s | grep -q Linux && curl -LRsS https://get.docker.com/ | bash && sudo usermod -aG docker $(whoami)"

# sudoeradd
sudoeradd() {(set -e; SDR="${1:?}"; SDRF=/etc/sudoers.d/administrators; ROW="${SDR} ALL=(ALL) NOPASSWD:ALL"; if ! id "${SDR}" 1>/dev/null 2>&1; then sudo useradd -m -s /bin/bash -b /home "${SDR}"; yes "Password.${SDR}" | sudo passwd "${SDR}" 2>/dev/null || true; fi; if ! sudo grep -q "${ROW}" "${SDRF}" 2>/dev/null; then echo "${ROW}" | sudo tee -a "${SDRF}" 1>/dev/null; fi; sudo chmod 0600 "${SDRF}")}

# wget : 1 つの HTML ファイルとして保存する。
wget --mirror --page-requisites --html-extension --convert-links https://github.com/

# ssh-keygen : 秘密鍵を作成する。
ssh-keygen -t ed25519 -f ed25519_256.pem -C "https://djeeno.github.io/sh/keys" -N ""
ssh-keygen -t ecdsa -b 521 -f ecdsa_521.pem -C "https://djeeno.github.io/sh/keys" -N ""
ssh-keygen -t rsa -b 4096 -f rsa_4096.pem -C "https://djeeno.github.io/sh/keys" -N ""
# ssh-keygen : 公開鍵のフィンガープリントを表示する。
ssh-keygen -E md5 -l -f _path_to_public_key_

# ssh
ssh -fN -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"
ssh -fN -L 3306:"${MYSQL_HOSTNAME:?}":3306 "${BASTION_HOST:?}"
ssh -fN -L 6379:"${REDIS_HOSTNAME:?}":6379 "${BASTION_HOST:?}"

# rsync : 網羅的なコマンド例。
rsync -az -e 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' --rsync-path='ionice -c 3 nice -n 19 rsync' --exclude '.git' --exclude '.gitmodules' "${SSHUSER:?}@${SSHHOST:?}:~/" "/tmp/${SSHUSER:?}_${SSHHOST:?}/"

# difff : diff と sed だけで作られた色付き diff 。
difff() { (R=$(printf '\033[31m');G=$(printf '\033[32m');B=$(printf '\033[36m');W=$(printf '\033[1m');N=$(printf '\033[0m');diff -u "$@"|sed "s/^\(@@..*@@\)$/$B\1$N/g;s/^\(+.*\)$/$G\1$N/g;s/^\(-.*\)$/$R\1$N/g;s/^[^+-]*\(+++ [^ ].*\)/$W\1$N/g;s/^[^+-]*\(--- [^ ].*\)/$W\1$N/g;")}

# openssl : 証明書期限チェック。
openssl s_client -connect google.com:443 < /dev/null 2> /dev/null | openssl x509 -noout -dates
# openssl : 証明書チェーンチェック。
openssl s_client -connect google.com:443 < /dev/null 2> /dev/null | grep -E 'Certificate chain|[is]:/'

# find : 見つけたファイルの行数を出力する。 `+` 引数としてまとめて渡して実行。 `;` 個別に実行。
find . -name "*.html" -exec wc -l {} \+
find . -name "*.html" -exec wc -l {} \;

_readline_history() {
  if command -v brew >/dev/null; then
    brew install peco
  elif command -v apt-get >/dev/null; then
    apt-get update && apt-get install -y peco
  else
    echo "error: requires peco"
  fi
  READLINE_LINE=$(HISTTIMEFORMAT='' history | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | sed 's/^[[:space:]]*[0-9][0-9]*[[:space:]][[:space:]]*//' | peco --layout bottom-up)
  READLINE_POINT=${#READLINE_LINE}
} && bind -x '"\C-r":_readline_history'

# tac : ファイルの内容や標準入力の内容を逆順に出力する。 cat の逆。
tac() {
  awk_script="{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}"
  if [ $# -ge 1 ]; then
    cat "$@" | awk "${awk_script}"
  else
    awk "${awk_script}" /dev/stdin
  fi
}

# YAML と JSON を相互変換する。
ruby -ryaml -rjson -e 'puts YAML.dump(JSON.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.dump(YAML.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.pretty_generate(YAML.load(STDIN.read))'

# python 3 を探す
echo "$PATH" | tr : "\n" | xargs -I@ sh -c 'file @/python*' | grep -v cannot | grep -o "^/[^:]*" | xargs -I@ sh -c "@ -c 'import sys; v=sys.version_info; print(sys.executable) if v.major >= 3 and v.minor >= 0 else sys.exit()'" 2>/dev/null | grep "^/[^[:blank:]]*$"

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
node -e "console.log(Date.parse('$(date +%Y-%m-%dT%H:%M:%S%z)'));"
python -c "import dateutil.parser; print dateutil.parser.parse('$(date +%Y-%m-%dT%H:%M:%S%z)');"
ruby -e "require 'time'; puts Time.parse('$(date +%Y-%m-%dT%H:%M:%S%z)');"



# ==================================================
# git Git
# ==================================================

# git : 最新版をソースからインストールする。 ref. https://www.kernel.org/pub/software/scm/git/
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'apt-get update && apt-get install -y lib{curl4-gnutls,expat1,ssl,z}-dev gcc gettext make less tar wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'yum makecache && yum install -y {curl,expat,gettext,openssl,zlib}-devel gcc make less tar perl-ExtUtils-MakeMaker wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git

# git : git-completion git コマンドの保管 ＆ git-prompt プロンプトに git の status などを表示
test -f ~/.git-completion.bash || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash -o ~/.git-completion.bash"; test -f ~/.git-completion.bash && source "$_"
test -f ~/.git-prompt.sh || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh"; test -f ~/.git-prompt.sh && source "$_"
export GIT_PS1_SHOWDIRTYSTATE=1 GIT_PS1_SHOWUPSTREAM=1 GIT_PS1_SHOWUNTRACKEDFILES=1 GIT_PS1_SHOWSTASHSTATE=1; if [ "${BASH_VERSINFO[0]}" -ge 4 ]; then export PS1="${PS1//"\\\$"/\\\$\\\[\\\e[1;31m\\\]\$(__git_ps1)\\\[\\\e[00m\\\]}"; else export PS1="${PS1//"\\\$"/\$\[\e[1;31m\]\$(__git_ps1)\[\e[00m\]}"; fi

# git : auther / commiter を更新する。
git config --local user.name djeeno
git config --local user.email 29125616+djeeno@users.noreply.github.com

# git tag タグ作成＆リモートにプッシュ
git tag -a 0.0.1 && git push origin 0.0.1
# git tag タグ削除＆リモートにプッシュ
git tag -d 0.0.1 && git push origin :0.0.1

# git : リポジトリのルートディレクトリを出力する。
git rev-parse --show-toplevel

# git : ブランチ名を出力する。
git rev-parse --abbrev-ref HEAD

# git : [DANGER] 過去の commiter と auther を変更する。
git filter-branch -f --env-filter "GIT_AUTHOR_NAME='djeeno'; GIT_AUTHOR_EMAIL='29125616+djeeno@users.noreply.github.com'; GIT_COMMITTER_NAME='djeeno'; GIT_COMMITTER_EMAIL='29125616+djeeno@users.noreply.github.com';" HEAD



# ==================================================
# Linux
# ==================================================

# apt
apt-get () { if [ "$1" = update ]; then [ 43200 -ge $(($(date +%s)-$( { date -d "$(stat /var/lib/apt/lists/* | awk -F"Change:" "/Change:/ {print \$2}" | sort | tail -n 1)" +%s; } 2>/dev/null)+0)) ] || command apt-get update; else command apt-get "$@"; fi; } && export -f apt-get
apt-get update && apt-get install -y bsdmainutils   # column
apt-get update && apt-get install -y coreutils      # tail
apt-get update && apt-get install -y dnsutils       # dig
apt-get update && apt-get install -y expect
apt-get update && apt-get install -y htop
apt-get update && apt-get install -y iftop
apt-get update && apt-get install -y iproute2       # tc
apt-get update && apt-get install -y lsof
apt-get update && apt-get install -y mailutils      # mailx
apt-get update && apt-get install -y net-tools      # netstat
apt-get update && apt-get install -y nmap
apt-get update && apt-get install -y openssh-client # ssh
apt-get update && apt-get install -y parted
apt-get update && apt-get install -y perl
apt-get update && apt-get install -y procps         # ps
apt-get update && apt-get install -y smartmontools
apt-get update && apt-get install -y tcpdump
apt-get update && apt-get install -y telnet
apt-get update && apt-get install -y traceroute
apt-get update && apt-get install -y tree
apt-get update && apt-get install -y unzip
apt-get update && apt-get install -y util-linux     # fdisk
apt-get update && apt-get install -y vim
apt-get update && apt-get install -y wget
apt-get update && apt-get install -y whois
apt-get update && apt-get install -y zip
apt-get clean && rm -rf /var/lib/apt/lists/*

# apt まとめてインストールするためのコマンドを生成する。
curl -LRsS https://djeeno.github.io/sh/ | grep "^apt-get update && apt-get install -y " | awk "\$0=\$7" | tr "\n" " " | sed "s/^/apt-get update \&\& apt-get install -y /; s/ $//"

# du : ルートディレクトリより 1 階層掘って使用量を出力する。
du -h -d 1 --exclude=/proc /

# ps.sh : ps コマンドの代わり。
ps_sh() { _piddirs=$(find /proc -maxdepth 1 -type d -name '[0-9]*'); printf 'UID\tPID\tPPID\tCMD\n'; echo "$_piddirs" | sed s@/proc/@@ | while read -r PID; do if [ -d "/proc/$PID" ]; then printf '%s\t%d\t%d\t%s\n' "$(stat -c '%U' "/proc/$PID")" "$PID" "$(cut -d' ' -f4 "/proc/$PID/stat")" "$(cat -e "/proc/$PID/cmdline" | sed 's/\^@$//; s/\^@/ /g')"; fi; done; } && ps_sh

# alias : Linux 用よく使う alias 詰め合わせ。
alias rm='rm -i'; alias cp='cp -i'; alias mv='mv -i'; alias ls='ls --color=auto'; alias ll='ls -alF';

# nmcli
nmcli c mod ens0 ipv4.method manual ipv4.addresses 10.0.0.1/24 ipv4.gateway 10.0.0.254 ipv4.dns 10.0.0.254,8.8.8.8,1.1.1.1 ipv4.dns-search djeeno.localdomain

# CoreOS で tc コマンドを使う。
# ref. tc コマンドでネットワーク遅延やパケットロスを疑似的に発生させるメモ - ようへいの日々精進XP https://inokara.hateblo.jp/entry/2016/02/14/191853
toolbox
apt-get update && apt-get install -y iproute2
tc qdisc show   dev eth0
tc qdisc add    dev eth0 root netem delay 100ms
tc qdisc change dev eth0 root netem delay 200ms
tc qdisc del    dev eth0 root
tc qdisc add    dev eth0 root netem loss 5%
tc qdisc change dev eth0 root netem loss 10%
tc qdisc del    dev eth0 root



# ==================================================
# Mac
# ==================================================

# mac Mac / brew
brew install coreutils

# mac Mac で DNS キャッシュクリア
sudo killall -HUP mDNSResponder

# mac Mac のホスト名変更
scutil --get ComputerName ; scutil --get LocalHostName ; scutil --get HostName
scutil --set ComputerName "${Hostname:?}"; scutil --set LocalHostName "${Hostname:?}"



# ==================================================
# mysql MySQL
# ==================================================

# mysqldump : 指定した DATABASE を backup
DUMP_GZ="./${MYSQL_DB:?}_$(date +%Y%m%d_%H%M%S).dump.gz"
mysqldump --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --single-transaction "${MYSQL_DB:?}" | gzip - >"${DUMP_GZ:?}"
zcat "${DUMP_GZ:?}" | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" "${MYSQL_DB:?}"
# mysqldump : 全 DATABASE を backup
mysqldump --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --single-transaction --all-databases | gzip - >"${DUMP_GZ:?}"
zcat all_databases.dump.gz | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}"

# mysql ユーザを追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY '${MYSQL_PWD:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY PASSWORD '${MYSQL_PWD_HASH:?}' WITH GRANT OPTION;"

# mysql ユーザーの権限を表示する
mysql -e "SHOW GRANTS;"
mysql -e "SHOW GRANTS FOR '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql ユーザーの権限を追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
mysql -e "GRANT FILE ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:-192.168.0.0/255.255.0.0}';"
# mysql ユーザーの権限を削除する
mysql -e "REVOKE FILE ON *.* FROM '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql 権限テーブルをリロードする
mysql -e "FLUSH PRIVILEGES;"

# mysql ユーザー一覧を表示する
mysql -e "SELECT host,user,password,plugin FROM mysql.user;"

# mysql 現在の接続数を表示する
mysql -e "SHOW STATUS LIKE 'Threads_connected';"

# mysql innodb status log を出力する設定を確認する
mysql -e "SHOW VARIABLES LIKE 'innodb_print_all_deadlocks';"

# mysql 現在接続しているユーザー一覧を表示する
mysql -e "SELECT * FROM information_schema.PROCESSLIST;"
# mysql 60 秒以上経過している接続を表示する
mysql -e "SELECT * FROM information_schema.PROCESSLIST WHERE time >= 60 AND user != 'rdsadmin';"
mysql -e "SELECT GROUP_CONCAT(id) FROM information_schema.PROCESSLIST WHERE time >= 60 AND user != 'rdsadmin';"
# mysql 処理中の接続を表示する
mysql -e "SHOW PROCESSLIST;"
mysql -e "SHOW FULL PROCESSLIST;"
# mysql 接続を殺す
mysql -e "KILL ${MYSQL_CONNECTION_ID:?};"
# mysql 起動してからの累計接続数を表示する
mysql -e "SHOW STATUS LIKE 'Conn%';"
# mysql Master か Replica か判定 (Master は OFF, Replica は ON)
mysql -e "SHOW GLOBAL VARIABLES LIKE 'innodb_read_only';"

# mysql create database データベースを作成する
mysql -e "CREATE DATABASE '${MYSQL_DB:?}' DEFAULT CHARACTER SET utf8mb4;"
# mysql db_for_test データベースが存在しなければ, CREATE DATABASE する
MYSQL_PWD="${MYSQL_PWD:?}" mysql --user="${MYSQL_USER:?}" --host="${MYSQL_HOST:?}" -e "CREATE DATABASE IF NOT EXISTS '${MYSQL_DB:?}';";
# mysql データベース一覧を表示する
mysql -e "SHOW DATABASES;"
# mysql データベース詳細を表示する
mysql -e "SHOW CREATE DATABASE ${TABLE:?}\G"
# mysql 使用するデータベースを指定する
mysql -e "USE ${MYSQL_DB:?};"

# mysql テーブル一覧を表示する
mysql -e "SHOW TABLES;"
# mysql テーブル詳細を表示する
mysql -e "DESCRIBE ${TABLE:?};"
mysql -e "DESC ${TABLE:?};"
mysql -e "SHOW COLUMNS FROM ${TABLE:?};"
mysql -e "SHOW CREATE TABLE ${TABLE:?}\G"
# mysql 使用するテーブルを指定する
mysql -e "USE ${TABLE:?};"

# mysql Oracle で言うところの UPSERT. INSERTする時にユニークキーを含まないと複数行ヒットしてしまい、しかし内1行しか更新されないらしい（伝聞）
mysql -e "INSERT INTO ${TABLE:?} (__uniquekey__, __column1__) VALUES ('myAwesomeUniqueKey', 'myAwesomeValue') ON DUPLICATE KEY UPDATE __column1__ = 'myGreatValue', __column2__ = 100;"
mysql -e "SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; DELETE FROM employees WHERE emp_no = 10000;"

# mysql db database データベースのサイズを表示する
mysql -e "SELECT table_schema, SUM(data_length+index_length)/1024/1024/1024 AS GiB FROM information_schema.tables GROUP BY table_schema ORDER BY SUM(data_length+index_length) DESC;"

# mysql table テーブルのサイズを表示する
mysql -e "SELECT table_name, engine, table_rows, avg_row_length, FLOOR((data_length+index_length)/1024/1024/1024) AS AllGiB, FLOOR((data_length)/1024/1024/1024) AS DataGiB, FLOOR((index_length)/1024/1024/1024) AS IndexGiB FROM information_schema.tables WHERE table_schema=DATABASE() ORDER BY (data_length+index_length) DESC;"

# mysql INNODB STATUS を表示する
mysql -e "SHOW ENGINE INNODB STATUS;"

# mysql ~/.my.cnf の設定
tee -a "${MY_CNF:-/dev/null}" << MY_CNF
[client]
user                        = ${MYSQL_USER:?}
host                        = ${MYSQL_HOST:?}
port                        = 3306
password                    = ${MYSQL_PWD:?}
database                    = ${MYSQL_DB:?}
loose-default-character-set = utf8mb4
init_command                = 'SET NAMES utf8mb4;'
MY_CNF

# mysql : サンプルデータベース
curl -LRsS http://downloads.mysql.com/docs/world.sql.gz | gunzip - | mysql
git clone --depth=1 https://github.com/datacharmer/test_db.git /tmp/test_db && cd /tmp/test_db && mysql <./employees.sql



# ==================================================
# docker Docker
# ==================================================

# docker : djeeno/ubuntu:18.04 の docker コンテナを起動する。
docker run -it --rm --name workspace -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$(pwd):$(pwd)" djeeno/ubuntu:18.04 bash -c "cd $(pwd) && bash -l"

# docker : 今いる Git リポジトリをボリュームとしてマウントし docker コンテナを起動する。
docker run -it --rm --name workspace -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$(git rev-parse --show-toplevel):$(git rev-parse --show-toplevel)" djeeno/ubuntu:18.04 bash -c "cd $(pwd) && bash -l"

# docker : docker --cap-add=SYS_ADMIN と /sys/fs/cgroup の例。極めて強い権限のため取り扱い注意。
docker run -it --rm --cap-add=SYS_ADMIN -v /sys/fs/cgroup:/sys/fs/cgroup:ro debian:10.2 bash

# docker : terraform
docker run -it --rm -e GOOGLE_APPLICATION_CREDENTIALS=/credential.json -v "${GOOGLE_APPLICATION_CREDENTIALS:?}":/credential.json:ro -v "$HOME/.ssh:/root/.ssh" -v "$HOME/.vim:/root/.vim" -v "$HOME/.vimrc:/root/.vimrc" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$(git rev-parse --show-toplevel):$(git rev-parse --show-toplevel)" djeeno/terraform:0.12.23 bash -c "cd $(pwd) && bash -l"

# docker : よく使いそうな docker image たち
docker run -it --rm alpine          sh
docker run -it --rm debian:10.2     bash
docker run -it --rm debian:9.11     bash
docker run -it --rm debian:8.11     bash
docker run -it --rm ubuntu:18.04    bash
docker run -it --rm ubuntu:16.04    bash
docker run -it --rm ubuntu:14.04    bash
docker run -it --rm centos:8.1.1911 bash
docker run -it --rm centos:7.7.1908 bash
docker run -it --rm centos:6.10     bash

# docker : MySQL Server のコンテナを起動する。
docker network create common
docker run -di --rm --network common --name mysql_8_0 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:8.0
docker run -di --rm --network common --name mysql_5_7 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:5.7
docker run -di --rm --network common --name mysql_5_6 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:5.6
docker run -di --rm --network common --name mysql_8_0 -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_ROOT_PASSWORD="" mysql:8.0
docker run -di --rm --network common --name mysql_5_7 -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_ROOT_PASSWORD="" mysql:5.7
# docker : MySQL Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common mysql:8.0 sh -c "mysql -h mysql_8_0 -P 3306 -u root --password=password"
docker run -it --rm --network common mysql:5.7 sh -c "mysql -h mysql_5_7 -P 3306 -u root --password=password"
docker run -it --rm --network common mysql:5.6 sh -c "mysql -h mysql_5_6 -P 3306 -u root --password=password"
# docker : ローカルから docker 上の mysql への接続コマンド。
mysql -h 127.0.0.1 -P 3306 -u root --password=password

# docker : PostgreSQL Server のコンテナを起動する。
docker run -di --rm --network common --name postgres_9_6 -p 5432:5432 -e POSTGRES_PASSWORD=password postgres:9.6
# docker : PostgreSQL Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common postgres:9.6 sh -c "PGPASSWORD=password psql -h postgres_9_6 -U postgres"

# docker : Redis Server のコンテナを起動する。
docker run -di --rm --network common --name redis_5_0 -p 6379:6379 redis:5.0
docker run -di --rm --network common --name redis_4_0 -p 6379:6379 redis:4.0
docker run -di --rm --network common --name redis_3_2 -p 6379:6379 redis:3.2
docker run -di --rm --network common --name redis_2_8 -p 6379:6379 redis:2.8
# docker : Redis Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common redis:5.0 sh -c "redis-cli -h redis_5_0 -p 6379"
docker run -it --rm --network common redis:4.0 sh -c "redis-cli -h redis_4_0 -p 6379"
docker run -it --rm --network common redis:3.2 sh -c "redis-cli -h redis_3_2 -p 6379"
docker run -it --rm --network common redis:2.8 sh -c "redis-cli -h redis_2_8 -p 6379"

# docker : コンテナから CLI を実行する（ローカル環境を汚さないため）。
alias     mysql-docker='docker run -it --rm mysql:8.0 mysql'
alias redis-cli-docker='docker run -it --rm redis:5.0 redis-cli'
alias       aws-docker='docker run -it --rm -e AWS_PROFILE="${AWS_PROFILE}" -e AWS_REGION="${AWS_PROFILE}" -v ~/.aws:/root/.aws djeeno/awscli aws'

# docker : ビルド時に作成された不要な中間イメージを掃除する。
docker image ls --filter "dangling=true" -aq | xargs docker image rm

# docker : 全部 kill して rm する。掃除する。
{ docker ps -aq | xargs docker kill; docker ps -aq | xargs docker rm; }
{ docker container prune -f; docker volume prune -f; docker image prune -f; }
docker system prune -f

# docker : docker を root ユーザー以外でも実行できるように。
sudo usermod -aG docker "$(whoami)"

# docker : Docker for Windows を WSL1 から利用できるようにするための設定。
command -v docker.exe 1>/dev/null && export DOCKER_HOST=tcp://localhost:2375

# docker : Docker for Mac の LinuxKit の tty に接続する。
screen ~/Library/Containers/com.docker.docker/Data/vms/0/tty

# docker-compose : 最新の docker-compose をインストールする。
DOCKER_COMPOSE_URL="$(echo "https://github.com$(curl -LRsS https://github.com/docker/compose/releases | grep -Eo "/docker/compose/releases/download/[0-9\.]+/docker-compose-$(uname -s)-$(uname -m)" | head -n 1)" | tee /dev/stderr)"
sudo curl -LRsS "${DOCKER_COMPOSE_URL:?}" -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose

# docker-compose : `ERROR: readlink /var/lib/docker/overlay2: invalid argument` が出た時に実行する。
docker-compose down --rmi local
docker-compose down --rmi all

# api コンテナから db コンテナに MySQL 接続する。
docker-compose exec api bash -c 'mysql -h db -P 3306 -u root --password=password'



# ==================================================
# Kubernetes
# ==================================================

# kubect-wrapper displays the current-context and prompts for user confirmation
# when trying to execute kubectl's subcommands that can update the cluster's state.
kubectl() { (
  # if has 1 argument || has -h --help --dry-run option || Sub-commands that are not dangerous if executed without confirmation; then
  if [ $# -le 1 ] || { echo " $* " | grep -Eq -- ' -h | --help | --dry-run '; } \
    || { echo " $* " | grep -Eq ' api-resources | api-version | cluster-info | completion | config | describe | diff | explain | get | logs | top | version | wait '; }; then
    command kubectl "$@"
    return $?
  fi
  printf "\e[01;33m%s\n%s\e[0m" "# CurrentContext: " "#   "
  command kubectl config current-context
  printf "\e[01;33m%s\e[0m" "# Press Enter key to continue... "
  read -r
  command kubectl "$@"
)}



# ==================================================
# GCP
# ==================================================

# gcloud : 各種コンポーネントをアップデートする。
gcloud components update

# gcloud : TL;DR
gcloud config configurations create "${GCP_CONFIG:?}"
gcloud auth login
gcloud config set project "${GCP_PROJECT:?}"
gcloud config configurations list
# gcloud : 初期化
gcloud init --console-only
# gcloud : 現在利用している configuration の内容を表示する。
gcloud config list
# gcloud : configuration 一覧を表示する。
gcloud config configurations list
# gcloud : configuration を新規作成する ( 初期状態では 'default' が使用される )
gcloud config configurations create "${GCP_CONFIG:?}"
# gcloud : アカウントを設定する。
gcloud config set account "${GCP_ACCOUNT:?}"
# gcloud : アカウントを認証する - IAM アカウントの場合
gcloud auth login
# MEMO: gcloud auth application-default login
# gcloud : アカウントを認証する - サービスアカウントの場合
gcloud auth activate-service-account "${GCP_SERVICE_ACCOUNT}" --key-file "${GOOGLE_APPLICATION_CREDENTIALS:?}"
# gcloud : プロジェクトを設定する。
gcloud config set project "${GCP_PROJECT:?}"
# gcloud : 利用する configuration を切り替える。
gcloud config configurations activate "${GCP_CONFIG:?}"
# gcloud : peco で選択可能形式で configuration を切り替える。
gcloud config configurations activate "$(gcloud config configurations list | tail -n +2 | peco | awk '$0=$1')"

# gcloud : compute ssh
gcloud compute ssh --zone "${GCP_ZONE:?}" --project "${GCP_PROJECT:?}" "${GCE_INSTANCE:?}"
# gcloud : 変な operations が起こっていないか確認する。
gcloud compute operations list --sort-by=TIMESTAMP
gcloud compute operations list --sort-by=TIMESTAMP --project "${GCP_PROJECT:?}"

# gcloud : kubernetes cluster を作成する。
gcloud container clusters create "${GKE_CLUSTER:?}"
# gcloud : kubectl コマンドの設定ファイル ~/.kube/config を指定したクラスターのもので更新する。
# gcloud : `Unable to connect to the server: x509: certificate signed by unknown authority` が出た時に使う。
gcloud container clusters get-credentials --zone "${GCP_ZONE:?}" "${GKE_CLUSTER:?}"
gcloud container clusters get-credentials --zone "${GCP_ZONE:?}" --project "${GCP_PROJECT:?}" "${GKE_CLUSTER:?}"



# ==================================================
# VMware ESXi
# ==================================================

/Applications/"VMware OVF Tool"/ovftool --noSSLVerify --datastore="${ESXI_DATASTORE:?}" "vi://${ESXI_USER:?}:${ESXI_PASS:?}@${ESXI_HOST:?}/${ESXI_VM_PATH_WITH_RESOURCE_POOL:?}" "$HOME/Desktop/${OVF_NAME:?}.ova"



# ==================================================
# CircleCI
# ==================================================

# circleci : local で CircleCI を実行する。
circleci local execute



# ==================================================
# Unity
# ==================================================

# unity
curl -LsS https://unity3d.com/get-unity/download/archive | grep -Eo "href=\"unityhub://[^\"]+\"" | sed "s|^.*\"unityhub://\([^/]*\)/\([^\"]*\)\".*$|https://download.unity3d.com/download_unity/\2/UnitySetup-\1|"



# ==================================================
# vim
# ==================================================

# vim ${hoge} を ${hoge:?} に変換する。
# vim %s/\(\${[^:{}]*[^\?"]\)}/\1:?}/gc



# ====================================================================================================
#   ここまで
# ====================================================================================================

# (C) 2018 djeeno </code></pre>
