#!/usr/bin/env bash
# shellcheck disable=SC1090,SC2009,SC2034,SC2153
cat >/dev/null << '#newtstat.github.io/bash'
<link rel="icon" href="/favicon.ico" type="image/x-icon"><style>body{font-size:0;margin:0}code,pre{font-size:1rem;font-family:'Ricty Diminished',Osaka-Mono,Menlo,Monaco,Consolas,'Courier New','Andale Mono','Ubuntu Mono',monospace}</style><pre><code>##
#newtstat.github.io/bash
##



cat << "DOCUMENT"
+--!!注意!!----------------------------------------------------------------------------+
| このページをシェルスクリプトとして実行しないでください。                             |
| この index.html はシェルスクリプトとして実行されることを想定して作成されていません。 |
+--------------------------------------------------------------------------------------+

個人用コマンドチートシート。

  curl -LRsS https://newtstat.github.io/bash/

や

  _readline_helpme() {
    command -v peco 1>/dev/null || bash -c "$(curl -LRsS https://newtstat.github.io/bash/peco/)"
    READLINE_LINE=$(curl -LRsS https://newtstat.github.io/bash/ | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | peco --layout bottom-up)
    READLINE_POINT=${#READLINE_LINE}
  } && bind -x '"\C-n":_readline_helpme'

的に参照されることを期待しています。

(C) 2018 newtstat
DOCUMENT
exit 0

# ====================================================================================================
#   ここから
# ====================================================================================================

# ==================================================
# 共通
# ==================================================

# 一撃インストール系
bash -c "$(curl -fLRSs https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
bash -c "$(wget -O- -q https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
bash -c "$(curl -LRsS https://sdk.cloud.google.com/ | bash /dev/stdin --disable-prompts)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/git/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/asdf/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/asdf/golang/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/asdf/kubectl/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/asdf/kubetail/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/direnv/)"
bash -c "$(curl -LRsS https://newtstat.github.io/bash/peco/)"
bash -c "uname -s | grep -q Linux && curl -LRsS https://get.docker.com/ | bash && sudo usermod -aG docker $(whoami)"
curl -LR https://github.com/newtstat/cdiff/releases/latest/download/cdiff -o /usr/bin/cdiff && chmod -v +x /usr/bin/cdiff
curl -LR https://github.com/newtstat/kubectl-wrapper/releases/latest/download/kubectl -o /usr/bin/kubectl && chmod -v +x /usr/bin/kubectl
curl -LR https://raw.githubusercontent.com/johanhaleby/kubetail/1.6.12/kubetail -o /usr/bin/kubetail && chmod -v +x /usr/bin/kubetail

# yes を聞かれるコマンドの実装
if [[ " $* " =~ ".* -y .*"|".* --yes .*" ]]; then sh -c "yes y | ${cmd:?}"; fi

# find : 見つけたファイルの行数を出力する。 `+` 引数としてまとめて渡して実行。 `;` 個別に実行。
find . -name "*.html" -exec wc -l {} \+
find . -name "*.html" -exec wc -l {} \;

# complete
command -v kubeadm 1>/dev/null && eval "$(command kubeadm completion bash)"
command -v kubectl 1>/dev/null && eval "$(command kubectl completion bash)" && export KUBECTL_EXTERNAL_DIFF=cdiff

# sudoeradd
sudoeradd() { (set -eu && sdr="$1" sdrf=/etc/sudoers.d/administrators row="$sdr ALL=(ALL) NOPASSWD:ALL" && ! id "$sdr" 1>/dev/null 2>&1 && sudo useradd -m -s /bin/bash -b /home "$sdr" || : && ! sudo grep -q "$row" $sdrf 2>/dev/null && echo "$row" | sudo tee -a "$sdrf" 1>/dev/null || : && sudo chmod 0600 "$sdrf"); }

# pgrep
ps -o pid,command | grep -E "^[0-9]+ [^ ]*ssh .*"  # pgrep では確認できないプロセスコマンドも出力したい場合
pgrep -f "^[^ ]*ssh .*"

# wget : 1 つの HTML ファイルとして保存する。
wget --mirror --page-requisites --html-extension --convert-links https://github.com/

# ping
while :; do echo "$(date "+%Y-%m-%dT%H:%M:%S%z") $(ping -t 1 -c 2 one.one.one.one | tr -d '\n' | sed 's/---.*//')"; done

# ssh-keygen : 秘密鍵を作成する。
ssh-keygen -t ed25519 -f ed25519_256.pem -C "https://newtstat.github.io/bash/keys" -N ""
ssh-keygen -t ecdsa -b 521 -f ecdsa_521.pem -C "https://newtstat.github.io/bash/keys" -N ""
ssh-keygen -t rsa -b 4096 -f rsa_4096.pem -C "https://newtstat.github.io/bash/keys" -N ""
# ssh-keygen : 公開鍵のフィンガープリントを表示する。
ssh-keygen -E md5 -l -f _path_to_public_key_

# ssh port forward ポートフォワード
ssh -N -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"
ssh -F /dev/null -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"

# ssh port forward ポートフォワード バックグラウンド実行
ssh -fN -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"
ssh -fN -L 3306:"${MYSQL_HOSTNAME:?}":3306 "${BASTION_HOST:?}"
ssh -fN -L 6379:"${REDIS_HOSTNAME:?}":6379 "${BASTION_HOST:?}"

# while ssh : Pseudo-terminal will not be allocated because stdin is not a terminal.
echo "${HOSTS:?}" | while read -r LINE; do ssh "${LINE:?}" -n -T -- hostname; done
echo "${HOSTS:?}" | while read -r LINE; do ssh "${LINE:?}" -T -- hostname < /dev/null; done

# rsync : 網羅的なコマンド例。
ionice -c 3 nice -n 19 rsync -az -e 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' --rsync-path='ionice -c 3 nice -n 19 rsync' --exclude '.git' --exclude '.gitmodules' "${SSHUSER:?}@${SSHHOST:?}:~/" "/tmp/${SSHUSER:?}_${SSHHOST:?}/"

# difff : diff と sed だけで作られた色付き diff 。
cdiff() { (R=$(printf '\033[31m');G=$(printf '\033[32m');B=$(printf '\033[36m');W=$(printf '\033[1m');N=$(printf '\033[0m');diff -u "$@"|sed "s/^\(@@..*@@\)$/$B\1$N/g;s/^\(+.*\)$/$G\1$N/g;s/^\(-.*\)$/$R\1$N/g;s/^[^+-]*\(+++ [^ ].*\)/$W\1$N/g;s/^[^+-]*\(--- [^ ].*\)/$W\1$N/g;")} && alias difff=cdiff

# whilediff
whilediff () {(while :; do after=$("$@"); cdiff <(echo "${before}") <(echo "${after}"); before="${after}"; sleep "${WHILEDIFF_DURATION:=1}"; done)}

# openssl
openssl genrsa -out private.pem 2048  # 秘密鍵の生成
openssl rsa -text -in private.pem -noout  # 秘密鍵の確認
openssl req -new -key private.pem -out csr.pem  # CSR Certificate Signing Request の生成
openssl req -text -in csr.pem -noout  # CSR Certificate Signing Request の確認
openssl x509 -req -days "$(echo "365 * 5000" | bc)" -signkey private.pem -in csr.pem -out crt.pem  # 自己証明書の生成
openssl x509 -text -in crt.pem -noout  # 自己証明書の確認
openssl req -x509 -sha256 -nodes -days "$(echo "365 * 5000" | bc)" -newkey rsa:2048 -subj /CN=localhost -keyout private.pem -out crt.pem  # 自己証明書の作成
HOST=google.com && openssl s_client -servername ${HOST:?} -connect ${HOST:?}:443 < /dev/null 2> /dev/null | openssl x509 -noout -dates  # openssl : 証明書期限チェック。
HOST=google.com && openssl s_client -servername ${HOST:?} -connect ${HOST:?}:443 < /dev/null 2> /dev/null | grep -E "Certificate chain|[is]:"  # openssl : 証明書チェーンチェック。

# ffmpeg
ffmpeg -ss HH:MM:SS -to HH:MM:SS -i input.mp4 -c copy output.mp4
ffmpeg -ss seconds_from_start -t duration -i input.mp4 -c copy output.mp4

_readline_history() {
  if command -v brew >/dev/null; then
    brew install peco
  elif command -v apt-get >/dev/null; then
    apt-get update && apt-get install -y peco
  else
    echo "error: requires peco"
  fi
  READLINE_LINE=$(HISTTIMEFORMAT='' history | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | sed 's/^[[:space:]]*[0-9][0-9]*[[:space:]][[:space:]]*//' | peco --layout bottom-up)
  READLINE_POINT=${#READLINE_LINE}
} && bind -x '"\C-r":_readline_history'

# tac : ファイルの内容や標準入力の内容を逆順に出力する。 cat の逆。
tac() {
  awk_script="{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}"
  if [ $# -ge 1 ]; then
    cat "$@" | awk "${awk_script}"
  else
    awk "${awk_script}" /dev/stdin
  fi
}

# ==================================================
# bash Bash
# ==================================================
echo "${BEFORE//\\n/\\\\n}"
echo "${BEFORE//\"/\\\"}"



# ==================================================
# ruby Ruby
# ==================================================

# YAML と JSON を相互変換する。
ruby -ryaml -rjson -e 'puts YAML.dump(JSON.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.dump(YAML.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.pretty_generate(YAML.load(STDIN.read))'

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
ruby -e "require 'time'; puts Time.parse('$(date +%Y-%m-%dT%H:%M:%S%z)');"

# bundle install で Gem::RemoteFetcher::UnknownHostError が出る際の対処。 IPv6 で名前解決してほしくない。
dig +short A rubygems.org | awk '{printf "%-16s rubygems.org\n", $0}' | sudo tee -a /etc/hosts



# ==================================================
# node nodejs Node.js
# ==================================================

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
node -e "console.log(Date.parse('$(date +%Y-%m-%dT%H:%M:%S%z)'));"

# npm
npm install --save-dev @types/react @types/react-dom
npm install --save-dev eslint prettier
npm install --save-dev eslint-plugin-simple-import-sort

# npm exec == npx
npm exec create-react-app myapp --template typescript --use-npm
npx create-react-app myapp --template typescript --use-npm
npx create-react-app myapp --template redux-typescript --use-npm

# npm run lint
# {
#   "scripts": {
#     "lint": "set -x && npx prettier --check ./src && npx eslint --ext .ts,tsx ./src && npx tsc --noemit",
#     "fmt": "set -x && npx prettier --write ./src && npx eslint --ext .ts,tsx --fix ./src",
#   }
# }



# ==================================================
# python Python
# ==================================================

# python 3.4 or later を探す
echo "${PATH:?}:" | while read -d: -r BIN; do ls -1 "${BIN:?}/python"* 2>/dev/null; done | while read -r PYTHON3; do "${PYTHON3:?}" -c "import sys; v=sys.version_info; sys.stdout.write(str(v.major)+'.'+str(v.minor)+'.'+str(v.micro)+'\t'+sys.executable+'\n') if v.major >= 3 and v.minor >= 4 else sys.exit()" 2>/dev/null; done | sort -V | cut -f2 | grep "^/[^[:blank:]]*$" | tail -n 1

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
python -c "import dateutil.parser; import sys; sys.stdout.write(str(dateutil.parser.parse('$(date +%Y-%m-%dT%H:%M:%S%z)'))+'\n');"



# ==================================================
# go golang Go Golang
# ==================================================
export GOPRIVATE=github.com/newtstat



# ==================================================
# git Git
# ==================================================

# git : 最新版をソースからインストールする。 ref. https://www.kernel.org/pub/software/scm/git/
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'apt-get update && apt-get install -y libcurl4-gnutls-dev libexpat1-dev libssl-dev libz-dev gcc gettext make less tar wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'yum makecache && yum install -y curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc make less tar perl-ExtUtils-MakeMaker wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git

# git : git-completion git コマンドの保管 ＆ git-prompt プロンプトに git の status などを表示
test -f ~/.git-completion.bash || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash -o ~/.git-completion.bash"; test -f ~/.git-completion.bash && source "$_"
test -f ~/.git-prompt.sh || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh"; test -f ~/.git-prompt.sh && source "$_"
export GIT_PS1_SHOWDIRTYSTATE=1 GIT_PS1_SHOWUPSTREAM=1 GIT_PS1_SHOWUNTRACKEDFILES=1 GIT_PS1_SHOWSTASHSTATE=1; if [ "${BASH_VERSINFO[0]}" -ge 4 ]; then export PS1="${PS1//"\\\$"/\\\$\\\[\\\033[1;31m\\\]\$(__git_ps1)\\\[\\\033[00m\\\]}"; else export PS1="${PS1//"\\\$"/\$\[\033[1;31m\]\$(__git_ps1)\[\033[00m\]}"; fi

GIT_NAME=newtstat
GIT_EMAIL=29125616+newtstat@users.noreply.github.com
git ls-files "*\.go"  # マッチするファイルを ls
git commit --allow-empty -m "first commit"  # git commit 空コミット
git config --local user.name "${GIT_NAME:?}"  # git Auther, Commiter の name を更新
git config --local user.email "${GIT_EMAIL:?}"  # git Auther, Commiter の email を更新
git tag -a 0.0.1 && git push origin 0.0.1   # git tag タグ作成＆リモートにプッシュ
git tag -d 0.0.1 && git push origin :0.0.1  # git tag タグ削除＆リモートにプッシュ
git rev-parse --show-toplevel  # git リポジトリのルートディレクトリを出力
git rev-parse --abbrev-ref HEAD  # git ブランチ名を出力
git branch -a 2>/dev/null | grep -Ev "^\*|^[[:blank:]]+(remotes/|main$|master$)" | xargs echo git branch -d  # git branch -d 不要なブランチを削除
#git filter-branch -f --env-filter "GIT_AUTHOR_NAME='${GIT_NAME:?}'; GIT_AUTHOR_EMAIL='${GIT_EMAIL:?}'; GIT_COMMITTER_NAME='${GIT_NAME:?}'; GIT_COMMITTER_EMAIL='${GIT_EMAIL:?}';" HEAD  # git !!!DANGER!!! 過去の Auther と Commiter を変更
# git remote show origin リモートリポジトリのデフォルトブランチを取得する
git remote show origin | grep -E '[[:blank:]]*HEAD[[:blank:]]branch:[[:blank:]]*' | sed 's/[[:blank:]]*HEAD[[:blank:]]branch:[[:blank:]]*//g'



# ==================================================
# Linux
# ==================================================

# apt
export apt_update_cmd="last=\$(stat /var/lib/apt/lists/* 2>/dev/null | awk -F\"Change:\" \"/Change:/ {print \\\$2}\" | sort | tail -n 1); [ 43200 -ge \$((\$(date +%s)-\$(date -d\"\${last:=1970-1-1}\" +%s))) ] || command apt update"
apt-get update && apt-get install -y bsdmainutils   # column
apt-get update && apt-get install -y coreutils      # tail
apt-get update && apt-get install -y dnsutils       # dig
apt-get update && apt-get install -y expect
apt-get update && apt-get install -y htop
apt-get update && apt-get install -y iftop
apt-get update && apt-get install -y iproute2       # tc
apt-get update && apt-get install -y lsof
apt-get update && apt-get install -y mailutils      # mailx
apt-get update && apt-get install -y net-tools      # netstat
apt-get update && apt-get install -y nmap
apt-get update && apt-get install -y openssh-client # ssh
apt-get update && apt-get install -y parted
apt-get update && apt-get install -y perl
apt-get update && apt-get install -y procps         # ps
apt-get update && apt-get install -y smartmontools
apt-get update && apt-get install -y tcpdump
apt-get update && apt-get install -y telnet
apt-get update && apt-get install -y traceroute
apt-get update && apt-get install -y tree
apt-get update && apt-get install -y unzip
apt-get update && apt-get install -y util-linux     # fdisk
apt-get update && apt-get install -y vim
apt-get update && apt-get install -y wget
apt-get update && apt-get install -y whois
apt-get update && apt-get install -y zip
apt-get clean && rm -rf /var/lib/apt/lists/*

# for installing tmux
sudo yum install -y libevent-devel ncurses-devel && cd /usr/local/src && sudo wget https://github.com/tmux/tmux/releases/download/3.2a/tmux-3.2a.tar.gz && sudo tar xfz tmux-3.2a.tar.gz && cd tmux-3.2a && ./configure && sudo make && sudo make install

# lsof このファイルをどのプロセスが使っているか
lsof /bin/bash
# lsof -i このポートをどのプロセスが使っているか
lsof -i tcp:8080
# lsof -t プロセス ID だけ出す
kill "$(lsof -t -i tcp:8080)"

# tcpdump
sudo tcpdump -G300 -W1 -vvv -l -n -p -s 65535 -w "${HOSTNAME}_%Y%m%dT%H%M%S.pcap"
tshark -r "${HOSTNAME}_%Y%m%dT%H%M%S.pcap"

# nm
nm /usr/lib/libcrypto.*

# apt まとめてインストールするためのコマンドを生成する。
curl -LRsS https://newtstat.github.io/bash/ | grep "^apt-get update && apt-get install -y " | awk "\$0=\$7" | tr "\n" " " | sed "s/^/apt-get update \&\& apt-get install -y /; s/ $//"

# du : ルートディレクトリより 1 階層掘って使用量を出力する。
du -h -d 1 --exclude=/proc /

# ps STAT 列に書いてあることの意味
man ps
# PROCESS STATE CODES
#        Here are the different values that the s, stat and state output specifiers (header "STAT" or "S") will display to describe the state of a process:
# 
#                D    uninterruptible sleep (usually IO)
#                R    running or runnable (on run queue)
#                S    interruptible sleep (waiting for an event to complete)
#                T    stopped by job control signal
#                t    stopped by debugger during the tracing
#                W    paging (not valid since the 2.6.xx kernel)
#                X    dead (should never be seen)
#                Z    defunct ("zombie") process, terminated but not reaped by its parent
# 
#        For BSD formats and when the stat keyword is used, additional characters may be displayed:
# 
#                <    high-priority (not nice to other users)
#                N    low-priority (nice to other users)
#                L    has pages locked into memory (for real-time and custom IO)
#                s    is a session leader
#                l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)
#                +    is in the foreground process group

# ps.sh : ps コマンドの代わり。
ps_sh() { _piddirs=$(find /proc -maxdepth 1 -type d -name "[0-9]*"); printf "UID\tPID\tPPID\tCMD\n"; echo "$_piddirs" | sed s@/proc/@@ | while read -r PID; do if [ -d "/proc/$PID" ]; then printf "%s\t%d\t%d\t%s\n" "$(stat -c "%U" "/proc/$PID")" "$PID" "$(cut -d" " -f4 "/proc/$PID/stat")" "$(cat -e "/proc/$PID/cmdline" | sed "s/\^@$//; s/\^@/ /g")"; fi; done; } && ps_sh

# alias : Linux 用よく使う alias 詰め合わせ。
alias rm='rm -i'; alias cp='cp -i'; alias mv='mv -i'; alias ls='ls --color=auto'; alias ll='ls -alF';

# nmcli
nmcli c mod ens0 ipv4.method manual ipv4.addresses 10.0.0.1/24 ipv4.gateway 10.0.0.254 ipv4.dns 10.0.0.254,8.8.8.8,1.1.1.1 ipv4.dns-search newtstat.localdomain

# CoreOS で tc コマンドを使う。
# ref. tc コマンドでネットワーク遅延やパケットロスを疑似的に発生させるメモ - ようへいの日々精進XP https://inokara.hateblo.jp/entry/2016/02/14/191853
toolbox
apt-get update && apt-get install -y iproute2
tc qdisc show   dev eth0
tc qdisc add    dev eth0 root netem delay 100ms
tc qdisc change dev eth0 root netem delay 200ms
tc qdisc del    dev eth0 root
tc qdisc add    dev eth0 root netem loss 5%
tc qdisc change dev eth0 root netem loss 10%
tc qdisc del    dev eth0 root



# ==================================================
# Mac
# ==================================================

# dotnet-install.sh https://docs.microsoft.com/ja-jp/dotnet/core/tools/dotnet-install-script
curl -LRSs https://dot.net/v1/dotnet-install.sh | bash
# dotnet-core-uninstall
wget -c https://github.com/dotnet/cli-lab/releases/latest/download/dotnet-core-uninstall.tar.gz -O /tmp/dotnet-core-uninstall.tar.gz ; mkdir -p ~/dotnet-core-uninstall ; tar -zxf /tmp/dotnet-core-uninstall.tar.gz -C ~/dotnet-core-uninstall ; cd ~/dotnet-core-uninstall ; ./dotnet-core-uninstall -h
# dotnet uninstall : dotnet --list-sdks
sudo bash -cx "rm -v -rf /usr/local/share/dotnet/sdk/${version:?} /usr/local/share/dotnet/shared/Microsoft.NETCore.App/${version:?} /usr/local/share/dotnet/shared/Microsoft.AspNetCore.All/${version:?} /usr/local/share/dotnet/shared/Microsoft.AspNetCore.App/${version:?} /usr/local/share/dotnet/host/fxr/${version:?}"
# mono uninstall  ref. https://www.mono-project.com/docs/about-mono/supported-platforms/macos/#uninstalling-mono-on-macos
sudo bash -cx "rm -v -rf /Library/Frameworks/Mono.framework; pkgutil --forget com.xamarin.mono-MDK.pkg; sudo rm /etc/paths.d/mono-commands"
#
ln -sf "$(find /usr/local/Cellar/mono/[0-9].[0-9]* -maxdepth 0 | sort -V | tail -n 1)" /usr/local/Cellar/mono/latest

# k9s : kubectl の TUI https://github.com/derailed/k9s
brew install derailed/k9s/k9s

# mac Mac / brew
brew install bash bash-completion coreutils make

# mac Mac で DNS キャッシュクリア
sudo killall -HUP mDNSResponder

# mac Mac のホスト名変更
scutil --get ComputerName ; scutil --get LocalHostName ; scutil --get HostName
scutil --set ComputerName "${Hostname:?}"; scutil --set LocalHostName "${Hostname:?}"

# xcode XCode
xcode-select --install
sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

# iCloud
ln -s ~/Library/Mobile*Documents/com~apple~CloudDocs ~/iCloud



# ==================================================
# mysql MySQL
# ==================================================

# mysql MYSQL_PWD 環境ヘンスを用いて認証を警告無しで通す
MYSQL_PWD="${MYSQL_PWD:?}" mysql --user="${MYSQL_USER:?}" --host="${MYSQL_HOST:?}" -e "SELECT VERSION();";

# mysql 死活監視
while sleep 1; do MYSQL_PWD="${MYSQL_PWD:?}" mysql -u "${MYSQL_USER:?}" -h "${MYSQL_HOST:?}" -e "SELECT '$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+0900) alive'" -BN ; done

# mysqldump : 指定した DATABASE を backup する。 Unknown table 'COLUMN_STATISTICS' in information_schema (1109) が出たらオプション --skip-column-statistics を付ける
DUMP_GZ="./${MYSQL_DB:?}_$(date +%Y%m%d_%H%M%S).dump.gz"
mysqldump --routines --hex-blob --single-transaction --set-gtid-purged=OFF --default-character-set=utf8mb4 --host="${MYSQL_HOST:?}" --port="${MYSQL_PORT:?}" --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --databases "${MYSQL_DB:?}" "${MYSQL_DB_2:?}" | gzip - >"${DUMP_GZ:?}"
zcat "${DUMP_GZ:?}" | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" "${MYSQL_DB:?}"
# mysqldump : 全 DATABASE を backup する。 Unknown table 'COLUMN_STATISTICS' in information_schema (1109) が出たらオプション --skip-column-statistics を付ける
mysqldump --routines --hex-blob --single-transaction --set-gtid-purged=OFF --default-character-set=utf8mb4 --host="${MYSQL_HOST:?}" --port="${MYSQL_PORT:?}" --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --all-databases | gzip - >"${DUMP_GZ:?}"
zcat all_databases.dump.gz | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}"

# mysql ユーザを追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY '${MYSQL_PWD:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY PASSWORD '${MYSQL_PWD_HASH:?}' WITH GRANT OPTION;"

# mysql ユーザーの権限を表示する
mysql -e "SHOW GRANTS;"
mysql -e "SHOW GRANTS FOR '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql ユーザーの権限を追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
mysql -e "GRANT FILE ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:-192.168.0.0/255.255.0.0}';"
# mysql ユーザーの権限を削除する
mysql -e "REVOKE FILE ON *.* FROM '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql 権限テーブルをリロードする
mysql -e "FLUSH PRIVILEGES;"

mysql -e "SELECT host,user,password,plugin FROM mysql.user; -- mysql ユーザー一覧を表示する"
mysql -e "SHOW VARIABLES LIKE 'innodb_print_all_deadlocks'; -- mysql innodb status log を出力する設定を確認する"
mysql -e "SELECT * FROM sys.innodb_lock_waits; -- mysql lock LOCK ロック"
mysql -e "SELECT * FROM information_schema.INNODB_LOCKS; -- mysql lock LOCK ロックの状態を確認する"
mysql -e "SELECT trx_id, trx_state, trx_started FROM information_schema.INNODB_TRX; -- mysql transaction トランザクションの状態を確認する"
mysql -e "SHOW STATUS LIKE 'Threads_connected'; -- mysql connection 現在のコネクション数を表示する"
mysql -e "SHOW PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SHOW FULL PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST WHERE INFO LIKE 'SELECT%' ORDER BY TIME ASC; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST WHERE time >= 10 AND user NOT IN ('cloudsqlreplica', 'rdsadmin'); -- mysql connection 10 秒以上経過しているコネクションを表示する"
mysql -e "SELECT GROUP_CONCAT(id) FROM information_schema.PROCESSLIST WHERE time >= 10 AND user NOT IN ('cloudsqlreplica', 'rdsadmin'); -- mysql connection 10 秒以上経過しているコネクションを表示する"
mysql -e "KILL ${MYSQL_CONNECTION_ID:?}; -- mysql 接続を殺す"
mysql -e "SHOW STATUS LIKE 'Conn%'; -- mysql 起動してからの累計接続数を表示する"
mysql -e "SHOW GLOBAL VARIABLES LIKE 'innodb_read_only'; -- mysql Master か Replica か判定 (Master は OFF, Replica は ON)"
mysql -e "SELECT @@global.tx_isolation, @@session.tx_isolation; -- mysql transaction isolation level トランザクション分離レベル"
mysql -e "SHOW GLOBAL VARIABLES LIKE 'tx_isolation'; -- mysql transaction isolation level トランザクション分離レベル"
mysql -e "SHOW SESSION VARIABLES LIKE 'tx_isolation'; -- mysql transaction isolation level トランザクション分離レベル"

# mysql create database データベースを作成する
mysql -e "CREATE DATABASE '${MYSQL_DB:?}' DEFAULT CHARACTER SET utf8mb4 IF NOT EXISTS '${MYSQL_DB:?}';"
# mysql 使用するデータベースを指定する
mysql -e "USE ${MYSQL_DB:?};"
# mysql データベース一覧を表示する
mysql -e "SHOW DATABASES;"
# mysql データベース詳細を表示する
mysql -e "SHOW CREATE DATABASE ${MYSQL_DB:?}\G"

# mysql table テーブル一覧を表示する
mysql -e "SHOW TABLES;"
# mysql table テーブル詳細を表示する
mysql -e "DESCRIBE ${TABLE:?};"
mysql -e "DESC ${TABLE:?};"
mysql -e "SHOW COLUMNS FROM ${TABLE:?};"
mysql -e "SHOW CREATE TABLE ${TABLE:?}\G"

# mysql index
mysql -e "SHOW INDEX FROM ${TABLE:?}"

# mysql Oracle で言うところの UPSERT. INSERTする時にユニークキーを含まないと複数行ヒットしてしまい、しかし内1行しか更新されないらしい（伝聞）
mysql -e "INSERT INTO ${TABLE:?} (__uniquekey__, __column1__) VALUES ('myAwesomeUniqueKey', 'myAwesomeValue') ON DUPLICATE KEY UPDATE __column1__ = 'myGreatValue', __column2__ = 100;"
mysql -e "SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; DELETE FROM employees WHERE emp_no = 10000;"

# mysql db database データベースのサイズを表示する
mysql -e "SELECT table_schema, SUM(data_length+index_length)/1024/1024 AS MiB FROM information_schema.tables GROUP BY table_schema ORDER BY SUM(data_length+index_length) DESC;"

# mysql table テーブルのサイズを表示する
mysql -e "SELECT table_name, engine, table_rows, avg_row_length, FLOOR((data_length+index_length)/1024/1024) AS AllMiB, FLOOR((data_length)/1024/1024) AS DataMiB, FLOOR((index_length)/1024/1024) AS IndexMiB FROM information_schema.tables WHERE table_schema=DATABASE() ORDER BY (data_length+index_length) DESC;"

# mysql table の row 数を表示する
mysql -e "SELECT table_name, table_rows FROM information_schema.TABLES WHERE table_schema = '${MYSQL_DB:?}';"

# mysql INNODB STATUS を表示する
mysql -e "SHOW ENGINE INNODB STATUS;"

# mysql ~/.my.cnf の設定
tee -a "${MY_CNF:-"$HOME/.my.cnf"}" << MY_CNF
[client]
user                        = ${MYSQL_USER:?}
host                        = ${MYSQL_HOST:?}
port                        = 3306
password                    = ${MYSQL_PWD:?}
database                    = ${MYSQL_DB:?}
loose-default-character-set = utf8mb4
init_command                = 'SET NAMES utf8mb4;'
MY_CNF

# mysql : サンプルデータベース
curl -LRsS http://downloads.mysql.com/docs/world.sql.gz | gunzip - | mysql
git clone --depth=1 https://github.com/datacharmer/test_db.git /tmp/test_db && cd /tmp/test_db && mysql <./employees.sql

# gcloud cloud sql slow log : rows_examined = このクエリ実行時に何行に触ったか。当然、数字が大きいとマズい。 : https://blog.kamipo.net/entry/2018/03/22/084126
# メモ
# - IN 句に大量に指定いれると PK 絞り込みが効かなくなることがある
PYTHONIOENCODING=UTF-8 gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" logging read 'resource.type="cloudsql_database" AND logName="projects/'"${GOOGLE_CLOUD_PROJECT:?}"'/logs/cloudsql.googleapis.com%2Fmysql-slow.log" AND timestamp>="2021-01-01T00:00:00+09:00" AND timestamp<"2021-01-01T00:01:00+09:00"' --order="asc" --format="value(textPayload)"



# ==================================================
# docker Docker
# ==================================================

# docker login
gcloud auth configure-docker
aws --region "${AWS_REGION:?}" ecr get-login-password | docker login --username AWS --password-stdin https://"${ECR_REPO:?}"

# docker : newtstat/ubuntu:18.04 の docker コンテナを起動する。
docker run -dit --rm --name work -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.vimrc:/root/.vimrc" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$PWD:$PWD" --workdir "$PWD" newtstat/ubuntu:18.04 bash -l && docker exec -it work bash -l

# docker : 今いる Git リポジトリをボリュームとしてマウントし docker コンテナを起動する。
docker run -dit --rm --name work -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.vimrc:/root/.vimrc" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$(git rev-parse --show-toplevel):$(git rev-parse --show-toplevel)" --workdir "$PWD" newtstat/ubuntu:18.04 bash -l && docker exec -it work bash -l

# docker : docker --cap-add=SYS_ADMIN と /sys/fs/cgroup の例。極めて強い権限のため取り扱い注意。
docker run -it --rm --cap-add=SYS_ADMIN -v /sys/fs/cgroup:/sys/fs/cgroup:ro debian:10.2 bash

# docker env
docker run -it --rm -v "$(pwd -P)":"$(pwd -P)" -w "$(pwd -P)" --env-file <(env) alpine sh

# docker : よく使いそうな docker image たち
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" alpine sh
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:11 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:10 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:9  bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:8  bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:20.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:18.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:16.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:14.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:8 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:7 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:6 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" rockylinux/rockylinux:8 bash -c "yum install -y curl sudo; bash -l"

# plantuml Plant UML
docker run -d --rm -p 8931:8080 plantuml/plantuml-server:jetty

# docker : nginx NGINX
docker run -i --rm -p 8080:80 nginx
docker run -i -v "$(pwd -P)/nginx.conf":/etc/nginx/nginx.conf:ro -p 8080:80 nginx

# docker : MySQL Server のコンテナを起動する。
docker network create common
docker run -di --rm --network common --name mysql_8_0 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:8.0
docker run -di --rm --network common --name mysql_5_7 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:5.7
docker run -di --rm --network common --name mysql_5_6 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:5.6
docker run -di --rm --network common --name mysql_8_0 -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_ROOT_PASSWORD="" mysql:8.0
docker run -di --rm --network common --name mysql_5_7 -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_ROOT_PASSWORD="" mysql:5.7
# docker : MySQL Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common mysql:8.0 sh -c "mysql -h mysql_8_0 -P 3306 -u root --password=password"
docker run -it --rm --network common mysql:5.7 sh -c "mysql -h mysql_5_7 -P 3306 -u root --password=password"
docker run -it --rm --network common mysql:5.6 sh -c "mysql -h mysql_5_6 -P 3306 -u root --password=password"
# docker : ローカルから docker 上の mysql への接続コマンド。
mysql -h 127.0.0.1 -P 3306 -u root --password=password

# docker : PostgreSQL Server のコンテナを起動する。
docker run -di --rm --network common --name postgres_9_6 -p 5432:5432 -e POSTGRES_PASSWORD=password postgres:9.6
# docker : PostgreSQL Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common postgres:9.6 sh -c "PGPASSWORD=password psql -h postgres_9_6 -U postgres"

# docker : Redis Server のコンテナを起動する。
docker run -di --rm --network common --name redis_5_0 -p 6379:6379 redis:5.0
docker run -di --rm --network common --name redis_4_0 -p 6379:6379 redis:4.0
docker run -di --rm --network common --name redis_3_2 -p 6379:6379 redis:3.2
docker run -di --rm --network common --name redis_2_8 -p 6379:6379 redis:2.8
# docker : Redis Server への接続コマンドをコンテナ上で実行する。
docker run -it --rm --network common redis:5.0 sh -c "redis-cli -h redis_5_0 -p 6379"
docker run -it --rm --network common redis:4.0 sh -c "redis-cli -h redis_4_0 -p 6379"
docker run -it --rm --network common redis:3.2 sh -c "redis-cli -h redis_3_2 -p 6379"
docker run -it --rm --network common redis:2.8 sh -c "redis-cli -h redis_2_8 -p 6379"

# nats
docker run -it --rm --network common -p 4222:4222 -p 8222:8222 -p 6222:6222 nats:2.5-alpine

# docker : コンテナから CLI を実行する（ローカル環境を汚さないため）。
alias     mysql-docker='docker run -it --rm mysql:8.0 mysql'
alias redis-cli-docker='docker run -it --rm redis:5.0 redis-cli'
alias       aws-docker='docker run -it --rm -e AWS_PROFILE="${AWS_PROFILE}" -e AWS_REGION="${AWS_PROFILE}" -v ~/.aws:/root/.aws newtstat/awscli aws'

# docker : ビルド時に作成された不要な中間イメージを掃除する。
docker image ls --filter "dangling=true" -aq | xargs docker image rm

# docker : 全部 kill して rm する。掃除する。
{ docker ps -aq | xargs docker kill; docker ps -aq | xargs docker rm; }
{ docker container prune -f; docker volume prune -f; docker image prune -f; docker system prune -f; }

# docker : docker を root ユーザー以外でも実行できるように。
sudo usermod -aG docker "$(whoami)"

# docker : Docker for Windows を WSL1 から利用できるようにするための設定。
command -v docker.exe 1>/dev/null && export DOCKER_HOST=tcp://localhost:2375

# docker : Docker for Mac の LinuxKit の tty に接続する。 2021-07-01 使えなくなってた。
screen ~/Library/Containers/com.docker.docker/Data/vms/0/tty
# docker : Docker for Mac の LinuxKit にログイン
docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh

# docker-compose : 最新の docker-compose をインストールする。
sudo curl -LRsS "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/bin/docker-compose && sudo chmod +x /usr/bin/docker-compose

# docker-compose : `ERROR: readlink /var/lib/docker/overlay2: invalid argument` が出た時に実行する。
docker-compose down --rmi local
docker-compose down --rmi all

# api コンテナから db コンテナに MySQL 接続する。
docker-compose exec api bash -c 'mysql -h db -P 3306 -u root --password=password'

# docker build
curl -Ss https://github.com/hashicorp/terraform/releases/ | grep -Eo "releases/tag/v[0-9]+\.[0-9]+\.[0-9]+" | awk -F "releases/tag/v" "\$0=\$2" | tee /dev/stderr | while read -r VERSION; do printf "%s\n%s\n%s\n%s\n" "FROM hashicorp/terraform:${VERSION}" "RUN apk add --no-cache bash" "ENTRYPOINT []" "CMD terraform" | docker build -t "newtstat/terraform:${VERSION}" - && docker push "newtstat/terraform:${VERSION}"; done



# ==================================================
# Kubernetes
# ==================================================
kubectl config current-context  # ~/.kube/config が向いている context を表示する
kubectl rollout status deployment "${DEPLOYMENT_NAME:?}"  # Deplyment の rollout 状況の確認 wait コマンドに近い
kubectl rollout restart deployment "${DEPLOYMENT_NAME:?}"  # Deplyment の Pod 再起動
kubectl rollout undo deployment "${DEPLOYMENT_NAME:?}"  # 前のバージョンの Deplyment に切り戻し
kubectl --context="${KUBECTL_CONTEXT:?}" port-forward "service/${SERVICE_NAME:?}" "${LOCAL_PORT:?}:${SERVICE_PORT:?}"
kubectl -n kube-system get deployments
kubectl -n kube-system get --no-headers pods
kubectl -n kube-system edit serviceaccounts aws-load-balancer-controller
kubectl -n kube-system logs "$(kubectl -n kube-system get --no-headers pods -o name -l app.kubernetes.io/name=aws-load-balancer-controller)" -f
kubectl exec -n kube-system "$(kubectl -n kube-system get --no-headers pods -o name | grep -E "aws-node-[0-9A-Za-z]+" | tail -n 1)" -c aws-node -- env | grep AWS
kubectl -n kube-system rollout restart daemonset aws-node

kubectl delete node lima-rancher-desktop
kubectl -n kube-system delete deployment.apps/metrics-server deployment.apps/local-path-provisioner deployment.apps/coredns deployment.apps/traefik daemonset.apps/svclb-traefik

# kubetail regex
kubetail "^app-[0-9a-z]+-[0-9a-z]+" --regex --context "${KUBECTL_CONTEXT:?}" --namespace default --since 300s

# kubetail + pv 秒間何行ログ出力があるか表示する
kubetail "^app-[0-9a-z]+-[0-9a-z]+" --regex --context "${KUBECTL_CONTEXT:?}" --namespace default --since 300s 2>&1 | pv --line-mode --rate >/dev/null

# k9s を docker 経由で実行する
alias k9s='docker run --rm -it -v ${KUBECONFIG:-~/.kube/config}:/root/.kube/config:ro quay.io/derailed/k9s'



# ==================================================
# AWS aws Amazon Web Services
# ==================================================
# pass : Linux 上での aws-vault の動作要件
sudo apt-get install -y pass
# shellcheck disable=SC2155
export GPG_TTY="$(tty)"
pass init "${EMAIL:?}"

# gpg
gpg --expert --full-generate-key
read -p Name-Real: -r NAMEREAL && read -p Name-Email: -r NAMEEMAIL && read -p Passphrase: -s -r PASSPHRASE && echo && printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n" Key-Type:RSA Key-Length:4096 Key-Usage:cert Subkey-Type:RSA Subkey-Length:4096 Subkey-Usage:encrypt,sign,auth Name-Real:"${NAMEREAL:?}" Name-Email:"${NAMEEMAIL:?}" Expire-Date:0 Passphrase:"${PASSPHRASE:?}" | gpg --expert --full-generate-key --batch -
read -p Passphrase: -s -r PASSPHRASE && echo && gpg --symmetric --batch TARGET_FILE --passphrase "${PASSPHRASE:?}"
read -p Passphrase: -s -r PASSPHRASE && echo && gpg --decrypt --batch ENCRYPTED_FILE --passphrase "${PASSPHRASE:?}"
gpg --with-keygrip --list-keys
gpg --with-keygrip --list-secret-keys
gpg --armor --export --output "${KEYID:?}.gpg" "${KEYID:?}"
gpg --armor --export-secret-keys --output "${KEYID:?}.secret.gpg" "${KEYID:?}"
gpg --with-keygrip --list-secret-key
ls -ld ~/.gnupg/private-keys-v1.d/*

# aws-valut add 資格情報の登録
aws-vault add "${AWS_PROFILE:?}"

# aws-vault exec : aws sts UserId Account Arn を取得する
aws-vault exec "${AWS_PROFILE:?}" -- aws sts get-caller-identity

# MFA を矯正する IAM ポリシーを作成
# cf. https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/tutorial_users-self-manage-mfa-and-creds.html
# cf. https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_examples_aws_my-sec-creds-self-manage.html
aws iam create-policy --policy-name ForceMFA --policy-document https://newtstat.github.io/bash/aws/iam/policy/ForceMFA.json

# wasabi storage
aws --profile wasabi --endpoint-url=https://s3.ap-northeast-1.wasabisys.com s3 ls

# aws ec2 describe-instances (with tags) インスタンス一覧 タグ名
aws --region ap-northeast-1 ec2 describe-instances | jq -rc '.Reservations[].Instances[]|[.InstanceId,(.Tags[]|select(.Key=="Name").Value)]'
aws --region ap-northeast-1 ec2 describe-instances | jq -rc '.Reservations[].Instances[]|[.InstanceId,(.Tags[]|select(.Key=="eks:cluster-name").Value),(.Tags[]|select(.Key=="eks:nodegroup-name").Value)]|@tsv'

# aws cloudfront
aws cloudfront list-distributions | jq -r '.DistributionList.Items[]|select(.Aliases.Items|any(.=="'"${DOMAIN:?}"'"))|.Id'

# To install the Session Manager plugin using the bundled installer (macOS) https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html#install-plugin-macos
curl -#fLR "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "/tmp/sessionmanager-bundle.zip" && unzip -o -d /tmp /tmp/sessionmanager-bundle.zip && sudo /tmp/sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin

# aws ecs execute-command
aws-vault exec "${AWS_PROFILE:?}" -- aws ecs execute-command --cluster "${ECS_CLUSTER:?}" --task "${ECS_TASK:?}" --container "${CONTAINER_NAME:?}" --interactive --command "/bin/bash"



# ==================================================
# GCP gcp gcloud Google Cloud Platform
# ==================================================

# gcloud 各種コンポーネントをアップデートする。
gcloud components update

# gcloud TL;DR
gcloud config configurations create "${GCP_CONFIG:?}"
gcloud auth login
gcloud config set project "${GOOGLE_CLOUD_PROJECT:?}"
gcloud config configurations list
# gcloud 初期化
gcloud init --console-only
# gcloud 現在利用している configuration の内容を表示する。
gcloud config list
# gcloud configuration 一覧を表示する。
gcloud config configurations list
# gcloud configuration を新規作成する ( 初期状態では 'default' が使用される )
gcloud config configurations create "${GCP_CONFIG:?}"
# gcloud アカウントを設定する。
gcloud config set account "${GCP_ACCOUNT:?}"
# gcloud auth login : ログインする
gcloud auth login
# gcloud auth application-default login : ログインし Cloud SDK のデフォルトの認証情報として利用する
gcloud auth application-default login
# gcloud auth revoke : ログアウトする
gcloud auth revoke
# gcloud --impersonate-service-account auth print-access-token 死んでもクレデンシャルファイルは発行するな
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud --impersonate-service-account="${SERVICEACCOUNT_NAME:?}@${GOOGLE_CLOUD_PROJECT:?}.iam.gserviceaccount.com" auth print-access-token)
# gcloud auth activate-service-account : サービスアカウントを用いて認証する
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" auth activate-service-account "${GCP_SERVICE_ACCOUNT}" --key-file "${GOOGLE_APPLICATION_CREDENTIALS:?}"
# gcloud config set project : プロジェクトを設定する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config set project "${GOOGLE_CLOUD_PROJECT:?}"
# gcloud config configurations activate : 利用する configuration を切り替える。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config configurations activate "${GCP_CONFIG:?}"
# gcloud config configurations activate : peco で選択可能形式で configuration を切り替える。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config configurations activate "$(gcloud config configurations list | tail -n +2 | peco | awk '$0=$1')"
# gcloud compute instances list : 構築順にソート
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute instances list --format="json" | jq -r "sort_by(.creationTimestamp)|.[]|[.creationTimestamp,.name]|@tsv"
# gcloud compute ssh
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute ssh --zone "${GCP_ZONE:?}" "${GCE_INSTANCE:?}"
# gcloud compute ssh portforward
ssh -F /dev/null -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand="bash -cx \"gcloud --project ${GOOGLE_CLOUD_PROJECT:?} compute ssh --zone ${GCE_ZONE:?} --tunnel-through-iap %r@%h -- -t -N -L ${LOCAL_PORT:?}:${REMOTE_HOST:?}:${REMOTE_PORT:?}\"" -l "${SSH_USER:?}" "${GCE_INSTANCE:?}"
# gcloud compute config-ssh
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute config-ssh --ssh-config-file=~/.ssh/"${GOOGLE_CLOUD_PROJECT:?}"
# gcloud compute firewall-rules create
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute firewall-rules create "ssh-via-iap" --description="allow SSH vis IAP" --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:22 --source-ranges="35.235.240.0/20" --target-tags="ssh-via-iap"
# gcloud compute instances create terraform
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute instances create "terraform" --zone="${GCP_ZONE:?}" --machine-type="e2-highcpu-2" --network-interface="network-tier=PREMIUM,subnet=default" --maintenance-policy=MIGRATE --service-account="terraform@${GOOGLE_CLOUD_PROJECT:?}.iam.gserviceaccount.com" --scopes="https://www.googleapis.com/auth/cloud-platform" --tags="ssh-via-iap" --create-disk="auto-delete=yes,boot=yes,device-name=terraform,image=projects/ubuntu-os-cloud/global/images/$(gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute images list --filter="family=ubuntu-2004-lts" --format="value(name)"),mode=rw,size=20,type=projects/${GOOGLE_CLOUD_PROJECT:?}/zones/${GCP_ZONE:?}/diskTypes/pd-balanced" --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
# gcloud start-iap-tunnel portforward
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute start-iap-tunnel --zone "${GCP_ZONE:?}" "${GCE_INSTANCE:?}" 22 --local-host-port=localhost:25252
# gcloud 変な operations が起こっていないか確認する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP --project "${GOOGLE_CLOUD_PROJECT:?}"
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP | grep -i hostError
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP | grep -i err
# gcloud endpoints quota list 割り当て確認
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" alpha endpoints quota list
# gcloud kubernetes cluster を作成する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters create "${GKE_CLUSTER:?}"
# gcloud kubectl コマンドの設定ファイル ~/.kube/config を指定したクラスターのもので更新する。
# gcloud `Unable to connect to the server: x509: certificate signed by unknown authority` が出た時に使う。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters get-credentials --zone "${GKE_REGION_OR_ZONE:?}" "${GKE_CLUSTER:?}"
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters get-credentials --region "${GKE_REGION_OR_ZONE:?}" "${GKE_CLUSTER:?}"
# gcloud logging read
PYTHONIOENCODING=UTF-8 gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" logging read '(resource.labels.container_name="AAA" OR resource.labels.container_name="BBB") AND "foobar" AND timestamp>="2021-06-15T00:00:00+09:00" AND timestamp<"2021-06-15T23:59:59+09:00"' --order="asc" --format="value(textPayload)"
# gcloud gsutil GOOGLE_APPLICATION_CREDENTIALS サービスアカウントの権限確認のために google/cloud-sdk を利用する。
TEST_KEY=/path/to/key.json ; docker run -it -e GOOGLE_APPLICATION_CREDENTIALS="${TEST_KEY:?}" -v "${TEST_KEY:?}:${TEST_KEY:?}:ro" google/cloud-sdk sh -cx "gcloud auth activate-service-account --key-file ${GOOGLE_APPLICATION_CREDENTIALS:?} && bash -l"
# gcloud metadata.google.internal
curl -H Metadata-Flavor:Google http://metadata.google.internal/computeMetadata/v1/instance/
curl -H Metadata-Flavor:Google http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/email

# gsutil .boto ファイルを生成する
gsutil config -n

# gsutil cache-control GCS メタデータに cache-control: no-store を設定する
# https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Cache-Control#cacheability
gsutil -m setmeta -h "cache-control: no-store" -r "gs://${BUCKET:?}/${PATH_TO:?}"

# gcloud services enable プロジェクトで利用できるサービスを有効化
gcloud services enable run.googleapis.com



# ==================================================
# terraform Terraform
# ==================================================
terraform walk "$(terraform find-tf .)" -- direnv exec . terraform init -upgrade



# ==================================================
# VMware ESXi
# ==================================================

/Applications/"VMware OVF Tool"/ovftool --noSSLVerify --datastore="${ESXI_DATASTORE:?}" "vi://${ESXI_USER:?}:${ESXI_PASS:?}@${ESXI_HOST:?}/${ESXI_VM_PATH_WITH_RESOURCE_POOL:?}" "$HOME/Desktop/${OVF_NAME:?}.ova"



# ==================================================
# CircleCI
# ==================================================

# circleci : local で CircleCI を実行する。
circleci local execute



# ==================================================
# Unity
# ==================================================

# unity download urls
curl -LsS https://unity3d.com/get-unity/download/archive | grep -Eo "href=\"unityhub://[^\"]+\"" | sed "s|^.*\"unityhub://\([^/]*\)/\([^\"]*\)\".*$|https://download.unity3d.com/download_unity/\2/UnitySetup-\1|"
# unity check ProjectSettings/ProjectVersion.txt
find "${PWD:?}" -name "ProjectVersion.txt" -print -exec cat {} \;



# ==================================================
# Hugo
# ==================================================
hugo new site . -f yml  # カレントディレクトリをルートとして新しく Hugo サイトを作成
git submodule add https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod --depth=1 && ( cd themes/PaperMod && git checkout v5.0 ) && echo 'theme: "PaperMod"' >> config.yml  # Hugo テーマ themes/PaperMod を追加
hugo new posts/20210926a.md  # 新しい記事を作成
hugo server -D  # draft の記事を含めてサーバーを起動する



# ==================================================
# vim
# ==================================================

# vim ${hoge} を ${hoge:?} に変換する。
# vim %s/\(\${[^!:{}\[\]]*[^\?"]\)}/\1:?}/gc  # 古
# vim %s/\(\${[^!:{}/-]*[^\?"-]\)}/\1:?}/gc   # 新



# ==================================================
# awk gawk
# ==================================================
printf '%d\n%d\n' 1 2               | awk '{sum+=$1} END {print sum}'
printf '%s\n%s\n' 'value1' 'value2' | awk '{ if (/^value2$/) print }'
printf '%s\n'     'before'          | awk '{ gsub(/before/, "\"after\""); print }'
printf '%s\n'     'value1,value2'   | awk '{ split($0, array, ","); print array[1] }'
printf '%s\n'     'abcdefghijklmn'  | awk '{ print toupper($0)}'
printf '%s\n'     'abcdefghijklmn'  | awk '{ print length($0)}'
printf '%s\n%s\n' 1 2               | awk '{print "'"$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+09:00)"'",$0}'
while :; do top -b -c -d 1 -n 1 -o "%CPU" -w 512 | awk '{print "'"$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+09:00)"'",$0}'; sleep 30; done > ~/"${HOSTNAME:?}_top_$(TZ=Asia/Tokyo date +%Y%m%dT%H%M%SJST).log"



# ====================================================================================================
#   ここまで
# ====================================================================================================

# (C) 2018 newtstat </code></pre>
