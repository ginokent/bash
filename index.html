#!/usr/bin/env bash
# shellcheck disable=SC1090,SC2002,SC2009,SC2034,SC2153,SC2317
cat >/dev/null << '#ginokent.github.io/bash'
<link rel="icon" href="/favicon.ico" type="image/x-icon"><style>body{font-size:0;margin:0}code,pre{font-size:1rem;font-family:'Ricty Diminished',Osaka-Mono,Menlo,Monaco,Consolas,'Courier New','Andale Mono','Ubuntu Mono',monospace}</style><pre><code>##
#ginokent.github.io/bash
##



cat << "DOCUMENT"
+--!!注意!!----------------------------------------------------------------------------+
| このページをシェルスクリプトとして実行しないでください。                             |
| この index.html はシェルスクリプトとして実行されることを想定して作成されていません。 |
+--------------------------------------------------------------------------------------+

個人用コマンドチートシート。

  curl -LRsS https://ginokent.github.io/bash/

や

  _readline_helpme() {
    command -v peco 1>/dev/null || bash -c "$(curl -LRsS https://ginokent.github.io/bash/peco/)"
    READLINE_LINE=$(curl -LRsS https://ginokent.github.io/bash/ | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | peco --layout bottom-up)
    READLINE_POINT=${#READLINE_LINE}
  } && bind -x '"\C-n":_readline_helpme'

的に参照されることを期待しています。

(C) 2018 ginokent
DOCUMENT
exit 0

# ====================================================================================================
#   ここから
# ====================================================================================================

# ==================================================
# 共通
# ==================================================

# 一撃インストール系
bash -c "$(curl -fLRSs --tlsv1.2 https://ginokent.github.io/keys.sh)"
bash -c "$(curl -fLRSs https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
bash -c "$(wget -O- -q https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
bash -c "$(curl -LRsS https://sdk.cloud.google.com/ | bash /dev/stdin --disable-prompts)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/git/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/asdf/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/asdf/golang/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/asdf/kubectl/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/asdf/kubetail/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/direnv/)"
bash -c "$(curl -LRsS https://ginokent.github.io/bash/peco/)"
bash -c "uname -s | grep -q Linux && curl -LRsS https://get.docker.com/ | bash && sudo usermod -aG docker $(whoami)"
curl -LR https://github.com/ginokent/cdiff/releases/latest/download/cdiff -o /usr/bin/cdiff && chmod -v +x /usr/bin/cdiff
curl -LR https://github.com/ginokent/kubectl-wrapper/releases/latest/download/kubectl -o /usr/bin/kubectl && chmod -v +x /usr/bin/kubectl
curl -LR https://raw.githubusercontent.com/johanhaleby/kubetail/1.6.12/kubetail -o /usr/bin/kubetail && chmod -v +x /usr/bin/kubetail
curl --tlsv1.2 -fLRSs https://raw.githubusercontent.com/versenv/versenv/HEAD/install.sh | VERSENV_SCRIPTS=kubectl,terraform,protoc,buf VERSENV_PATH=. bash


: "jq ignore" && printf '{"message":"valid json"}\ninvalid json\n' | jq -Rr '. as $line | try fromjson catch $line'

# yes を聞かれるコマンドの実装
if [[ " $* " =~ ".* -y .*"|".* --yes .*" ]]; then sh -c "yes y | ${cmd:?}"; fi

# find : 見つけたファイルの行数を出力する。 `+` 引数としてまとめて渡して実行。 `;` 個別に実行。
find . -name "*.html" -exec wc -l {} \+
find . -name "*.html" -exec wc -l {} \;

# complete
command -v kubeadm 1>/dev/null && eval "$(command kubeadm completion bash)"
command -v kubectl 1>/dev/null && eval "$(command kubectl completion bash)" && export KUBECTL_EXTERNAL_DIFF=cdiff

# sudoeradd
sudoeradd() { (set -eu && sdrf=/etc/sudoers.d/administrators row="$1 ALL=(ALL) NOPASSWD:ALL" && ! id "$1" 1>/dev/null 2>&1 && sudo useradd -m -s /bin/bash -b /home "$1" || : && ! sudo grep -q "$row" $sdrf 2>/dev/null && echo "$row" | sudo tee -a "$sdrf" 1>/dev/null || : && sudo chmod 0600 "$sdrf"); }

# pgrep
ps -o pid,command | grep -E "^[0-9]+ [^ ]*ssh .*"  # pgrep では確認できないプロセスコマンドも出力したい場合
pgrep -f "^[^ ]*ssh .*"

# wget : 1 つの HTML ファイルとして保存する。
wget --mirror --page-requisites --html-extension --convert-links https://github.com/

ping_sh() { while :; do echo "$(date "+%Y-%m-%dT%H:%M:%S%z") $({ ping -t 1 -c 2 "${1:?}" 2>&1 || sleep 1; } | tr -d '\n')"; done | sed 's/---.*//'; } && ping_sh one.one.one.one
while sleep 0.5; do ping one.one.one.one || echo "exit $?"; done

# ssh-keygen : 秘密鍵を作成する。
ssh-keygen -t ed25519 -f ed25519_256.pem -C "https://ginokent.github.io/keys" -N ""
ssh-keygen -t ecdsa -b 521 -f ecdsa_521.pem -C "https://ginokent.github.io/keys" -N ""
ssh-keygen -t rsa -b 4096 -f rsa_4096.pem -C "https://ginokent.github.io/keys" -N ""
# ssh-keygen : 公開鍵のフィンガープリントを表示する。
ssh-keygen -E md5 -l -f _path_to_public_key_

# ssh port forward ポートフォワード
ssh -N -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"
ssh -F /dev/null -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"

# ssh port forward ポートフォワード バックグラウンド実行
ssh -fN -L "${LOCAL_PORT:?}":"${REMOTE_HOST:?}":"${REMOTE_PORT:?}" "${BASTION_HOST:?}"
ssh -fN -L 3306:"${MYSQL_HOSTNAME:?}":3306 "${BASTION_HOST:?}"
ssh -fN -L 6379:"${REDIS_HOSTNAME:?}":6379 "${BASTION_HOST:?}"

# while ssh "Pseudo-terminal will not be allocated because stdin is not a terminal." 対策
# read で /dev/stdin を使っているので ssh コマンドでは /dev/stdin を /dev/null からリダイレクトする
cat hosts.txt | while read -r LINE; do ssh -n -T "${LINE:?}" -- hostname; done
cat hosts.txt | while read -r LINE; do ssh -T "${LINE:?}" -- hostname < /dev/null; done

# rsync : 網羅的なコマンド例。
ionice -c 3 nice -n 19 rsync -az -e 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' --rsync-path='ionice -c 3 nice -n 19 rsync' --exclude '.git' --exclude '.gitmodules' "${SSHUSER:?}@${SSHHOST:?}:~/" "/tmp/${SSHUSER:?}_${SSHHOST:?}/"

# cdiff (difff) : diff と sed だけで作った色付き diff
cdiff() { (if [ -t 0 ]; then P=printf C="\033" R=$($P "$C\[31m");G=$($P "$C\[32m");B=$($P "$C\[36m");W=$($P "$C\[1m");N=$($P "$C\[0m"); fi; diff -u "$@"|sed "s/^\(@@..*@@\)$/${B-}\1${N-}/;s/^\(+.*\)/${G-}\1${N-}/;s/^\(-.*\)/${R-}\1${N-}/;s/^${G-}\(+++ [^ ].*\)/${W-}\1/;s/^${R-}\(--- [^ ].*\)/${W-}\1/;")} && alias difff=cdiff && export -f cdiff

# whilediff
whilediff () {(while :; do after=$("$@"); cdiff <(echo "${before}") <(echo "${after}"); before="${after}"; sleep "${WHILEDIFF_DURATION:=1}"; done)} && export -f whilediff

# myip checkip
curl -fLRSs -w '\n' https://domains.google.com/checkip
curl -fLRSs https://checkip.amazonaws.com

#
throughput() { avgRTT=$(ping -c 10 -s 65507 "${1:?"target"}" | grep rtt | cut -d/ -f5) && mbps=$(echo "scale=2; (65535 * 8 * 2) / ${avgRTT:?} / 1000" | bc) && echo "${mbps:?} Mbps"; }

# openssl
: "RSA 秘密鍵の生成" && openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out private.pem
: "ECDSA 秘密鍵の生成" && openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:prime256v1 -out private.pem
: "ED25519 秘密鍵の生成" && openssl genpkey -algorithm ED25519 -out private.pem  # 秘密鍵の生成
openssl rsa -text -in private.pem -noout  # 秘密鍵の確認
openssl req -new -key private.pem -out csr.pem  # CSR Certificate Signing Request の生成
openssl req -text -in csr.pem -noout  # CSR Certificate Signing Request の確認
openssl x509 -req -days "$(echo "365 * 5000" | bc)" -signkey private.pem -in csr.pem -out crt.pem  # 自己証明書の生成
openssl x509 -text -in crt.pem -noout  # 自己証明書の確認
openssl req -x509 -sha256 -nodes -days "$(echo "365 * 5000" | bc)" -newkey rsa:2048 -subj /CN=localhost -keyout private.pem -out crt.pem  # 自己証明書の作成
certExpires () { openssl s_client -servername "${1:?}" -connect "${1:?}":443 < /dev/null 2> /dev/null | openssl x509 -noout -dates; } && certExpires one.one.one.one  # openssl 証明書期限のチェック
certChains () { openssl s_client -servername "${1:?}" -connect "${1:?}":443 < /dev/null 2> /dev/null | grep -E "Certificate chain|[is]:"; } && certChains one.one.one.one  # openssl 証明書チェーンのチェック

# QR Code
zbarimg qrcode.png

# ffmpeg
ffmpeg -ss HH:MM:SS -to HH:MM:SS -i input.mp4 -c copy output.mp4
ffmpeg -ss seconds_from_start -t duration -i input.mp4 -c copy output.mp4

_readline_history() {
  if command -v brew >/dev/null; then
    brew install peco
  elif command -v apt-get >/dev/null; then
    apt-get update && apt-get install -y peco
  else
    echo "error: requires peco"
  fi
  READLINE_LINE=$(HISTTIMEFORMAT='' history | awk "{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}" | sed 's/^[[:space:]]*[0-9][0-9]*[[:space:]][[:space:]]*//' | peco --layout bottom-up)
  READLINE_POINT=${#READLINE_LINE}
} && bind -x '"\C-r":_readline_history'

# tac : ファイルの内容や標準入力の内容を逆順に出力する。 cat の逆。
tac() {
  awk_script="{a[i++]=\$0}END{for(j=i-1;j>=0;j--)print a[j]}"
  if [ $# -ge 1 ]; then
    cat "$@" | awk "${awk_script}"
  else
    awk "${awk_script}" /dev/stdin
  fi
}

# ==================================================
# bash Bash
# ==================================================
echo "${BEFORE//\\n/\\\\n}"
echo "${BEFORE//\"/\\\"}"

: "bash のプロセス置換による /dev/stdin /dev/stdout /dev/stderr の代替" && bash -c "echo date | cat <(cat <&0) | tee >(cat >&1) | tee >(cat >&2)"



# ==================================================
# ruby Ruby
# ==================================================

# YAML と JSON を相互変換する。
ruby -ryaml -rjson -e 'puts YAML.dump(JSON.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.dump(YAML.load(STDIN.read))'
ruby -ryaml -rjson -e 'puts JSON.pretty_generate(YAML.load(STDIN.read))'

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
ruby -e "require 'time'; puts Time.parse('$(date +%Y-%m-%dT%H:%M:%S%z)');"

# bundle install で Gem::RemoteFetcher::UnknownHostError が出る際の対処。 IPv6 で名前解決してほしくない。
dig +short A rubygems.org | awk '{printf "%-16s rubygems.org\n", $0}' | sudo tee -a /etc/hosts


: "github-linguist リポジトリ内のコードのプログラミング言語使用割合を計測する" && docker run -it --rm -v "$(pwd):/repo" crazymax/linguist:latest



# ==================================================
# node nodejs Node.js
# ==================================================

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
node -e "console.log(Date.parse('$(date +%Y-%m-%dT%H:%M:%S%z)'));"

# npm
npm install --save-dev @types/react @types/react-dom
npm install --save-dev eslint prettier
npm install --save-dev eslint-plugin-simple-import-sort

# npm exec == npx
npm exec create-react-app myapp --template typescript --use-npm
npx create-react-app myapp --template typescript --use-npm
npx create-react-app myapp --template redux-typescript --use-npm

# npm run lint
# {
#   "scripts": {
#     "lint": "set -x && npx prettier --check ./src && npx eslint --ext .ts,tsx ./src && npx tsc --noemit",
#     "fmt": "set -x && npx prettier --write ./src && npx eslint --ext .ts,tsx --fix ./src",
#   }
# }



# ==================================================
# python Python
# ==================================================

# python 3.4 or later を探す
echo "${PATH:?}:" | while read -d: -r BIN; do ls -1 "${BIN:?}/python"* 2>/dev/null; done | while read -r PYTHON3; do "${PYTHON3:?}" -c "import sys; v=sys.version_info; sys.stdout.write(str(v.major)+'.'+str(v.minor)+'.'+str(v.micro)+'\t'+sys.executable+'\n') if v.major >= 3 and v.minor >= 4 else sys.exit()" 2>/dev/null; done | sort -V | cut -f2 | grep "^/[^[:blank:]]*$" | tail -n 1

# String to Date Time Oneliner : 文字列 日付時刻 変換用ワンライナー
python -c "import dateutil.parser; import sys; sys.stdout.write(str(dateutil.parser.parse('$(date +%Y-%m-%dT%H:%M:%S%z)'))+'\n');"

# virtualenv
export VIRTUALENV_DIR=/tmp/virtualenv_dir
python -m pip install --no-cache-dir --upgrade --user virtualenv
python -m pip install --no-cache-dir --upgrade virtualenv
python -m virtualenv "${VIRTUALENV_DIR:?}"
"${VIRTUALENV_DIR:?}/bin/python" -m pip install --no-cache-dir --upgrade opencv-python dlib numpy
"${VIRTUALENV_DIR:?}/bin/python" -m pip freeze | tee requirements.txt



# ==================================================
# go golang Go Golang
# ==================================================
export GOPRIVATE=github.com/ginokent

: "go キャッシュパス確認" && go env GOCACHE
: "go キャッシュ削除" && go clean -x -cache -testcache -modcache -fuzzcache

: "golangci-lint キャッシュパス確認" && golangci-lint cache status
: "golangci-lint キャッシュ削除" && golangci-lint cache clean



# ==================================================
# git Git
# ==================================================

# git : 最新版をソースからインストールする。 ref. https://www.kernel.org/pub/software/scm/git/
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'apt-get update && apt-get install -y libcurl4-gnutls-dev libexpat1-dev libssl-dev libz-dev gcc gettext make less tar wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git
# shellcheck disable=SC2016
install_git() { $(command -v sudo) bash -cx 'yum makecache && yum install -y curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc make less tar perl-ExtUtils-MakeMaker wget && cd /usr/local/src && URL=https://www.kernel.org/pub/software/scm/git/ && FILE=$(wget -qO- $URL | grep -o -E git-[0-9\\.]+.tar.gz | sort -uV | tail -n 1) && wget -cSv $URL$FILE && tar vxzf $FILE && cd $(basename -s .tar.gz $FILE) && make prefix=/usr/local all && make prefix=/usr/local install && cd .. && rm -rf $FILE $(basename -s .tar.gz $FILE) && /usr/local/bin/git --version'; } && install_git

# git : git-completion git コマンドの保管 ＆ git-prompt プロンプトに git の status などを表示
test -f ~/.git-completion.bash || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash -o ~/.git-completion.bash"; test -f ~/.git-completion.bash && source "$_"
test -f ~/.git-prompt.sh || bash -cx "curl -LR https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh"; test -f ~/.git-prompt.sh && source "$_"
export GIT_PS1_SHOWDIRTYSTATE=1 GIT_PS1_SHOWUPSTREAM=1 GIT_PS1_SHOWUNTRACKEDFILES=1 GIT_PS1_SHOWSTASHSTATE=1; if [ "${BASH_VERSINFO[0]}" -ge 4 ]; then export PS1="${PS1//"\\\$"/\\\$\\\[\\\033[1;31m\\\]\$(__git_ps1)\\\[\\\033[00m\\\]}"; else export PS1="${PS1//"\\\$"/\$\[\033[1;31m\]\$(__git_ps1)\[\033[00m\]}"; fi

GIT_NAME=ginokent
GIT_EMAIL=29125616+ginokent@users.noreply.github.com
: "Auther, Commiter の name を更新" && git config --local user.name "${GIT_NAME:?}"
: "Auther, Commiter の email を更新" && git config --local user.email "${GIT_EMAIL:?}"
: "remote head branch を取得" && git remote show origin | awk -F': ' '/HEAD branch: / { print $2 }'
: "head branch に切り替え" && bash -c "git checkout $(git remote show origin | awk -F': ' '/HEAD branch: / { print $2 }')"
: "head branch に checkout して pull してから元のブランチに switch して pull" && REMOTE_HEAD=$(git remote show origin | awk -F': ' '/HEAD branch: / { print $2 }') && bash -cx "git checkout ${REMOTE_HEAD:-main} && git pull -p --all && git switch $(git rev-parse --abbrev-ref HEAD) && git pull -p --all"
: "現在のブランチをバックアップ" && git checkout -b "$(date +"backup-$(git rev-parse --abbrev-ref HEAD)-%Y-%m-%dT%H-%M-%S")"
: "ブランチ切り替え" && git checkout main
: "ブランチ切り替え" && git switch main
: "パターンにマッチするファイルを一覧表示" && git ls-files "*\.go"
: "空コミット" && git commit --allow-empty -m "initial commit"
: "タグを一覧表示" && git tag --list | sort -V
: "タグ作成＆リモートにプッシュ" && git tag -a 0.0.1 && git push origin 0.0.1
: "タグ削除＆リモートにプッシュ" && git tag -d 0.0.1 && git push origin :0.0.1
git rev-parse --show-toplevel  # git リポジトリのルートディレクトリを出力
git rev-parse --abbrev-ref HEAD  # git ブランチ名を出力
: "不要なブランチを削除" && REMOTE_HEAD=$(git remote show origin | awk -F': ' '/HEAD branch: / { print $2 }') && git branch | grep -Ev "^\*|^[[:blank:]]+(main|master${REMOTE_HEAD:+"|${REMOTE_HEAD-}"})$" | xargs git branch -d
#git filter-branch -f --env-filter "GIT_AUTHOR_NAME='${GIT_NAME:?}'; GIT_AUTHOR_EMAIL='${GIT_EMAIL:?}'; GIT_COMMITTER_NAME='${GIT_NAME:?}'; GIT_COMMITTER_EMAIL='${GIT_EMAIL:?}';" HEAD  # git !!!DANGER!!! 過去の Auther と Commiter を変更
# git remote show origin リモートリポジトリのデフォルトブランチを取得する
git remote show origin | grep -E '[[:blank:]]*HEAD[[:blank:]]branch:[[:blank:]]*' | sed 's/[[:blank:]]*HEAD[[:blank:]]branch:[[:blank:]]*//g'
git pull --all --prune
git pull --all --prune --rebase
git commit -m "docs: Update README.md"



# ==================================================
# gh github GitHub
# ==================================================
gh issue list --repo ginokent/todo --search -status:Done --json title --jq 'sort_by(.title)|.[]|.title'
: "GitHub PR を閲覧, 無かったら作成" && (gh pr view --web || gh pr create --web)
: "head ブランチを main にマージ" && WORK_BRANCH=feat-merge-branch-head-into-main REMOTE_HEAD_BRANCH=$(git remote show origin | awk -F': ' '/HEAD branch: / { print $2 }') && git fetch -p --all && git switch "${REMOTE_HEAD_BRANCH:?}" && git branch -d "${WORK_BRANCH:?}" && git checkout -b "${WORK_BRANCH:?}" && git push -u origin "${WORK_BRANCH:?}" && gh pr create --base main --head "${WORK_BRANCH:?}" --title 'feat: Merge branch HEAD into main' --fill && gh pr view --web
: "GitHub Actions のすべてのキャッシュを削除" && gh cache list --json id --jq .[].id | xargs -I@ gh cache delete @
: "GitHub CLI Copilot 拡張機能をインストール" && gh extension install github/gh-copilot
: "GitHub CLI Copilot 拡張機能をアップデート" && gh extension upgrade gh-copilot

# ==================================================
# GitHub labels
# ==================================================
gh label create --force "BREAKING CHANGE" --description "BREAKING CHANGES" --color FF0303
gh label create --force "build" --description "Changes that affect the build system or external dependencies (example scopes: gulp, broccoli, npm)" --color 5319E7
gh label create --force "ci" --description "Changes to our CI configuration files and scripts (examples: CircleCi, SauceLabs)" --color 53C4EE
gh label create --force "docs" --description "Documentation only changes" --color 1B3E44
gh label create --force "feat" --description "A new feature" --color 0EAA80
gh label create --force "fix" --description "A bug fix" --color 1D76DB
gh label create --force "perf" --description "A code change that improves performance" --color A2EEEF
gh label create --force "refactor" --description "A code change that neither fixes a bug nor adds a feature" --color C5DEF5
gh label create --force "test" --description "Adding missing tests or correcting existing tests" --color 1D76DB
gh label create --force "chore" --description "Changes to the build process or auxiliary tools and libraries such as documentation generation" --color 20313F



# ==================================================
# Protocol Buffers proto3
# ==================================================
# empty.proto とか timestamp.proto とかの定義ファイルが置いてある protoc の include/google/protobuf の場所
ls -l ~/.cache/versenv/protoc/*/include/google/protobuf/*.proto



# ==================================================
# Linux
# ==================================================

# apt
export apt_update_cmd="last=\$(stat /var/lib/apt/lists/* 2>/dev/null | awk -F\"Change:\" \"/Change:/ {print \\\$2}\" | sort | tail -n 1); [ 43200 -ge \$((\$(date +%s)-\$(date -d\"\${last:=1970-1-1}\" +%s))) ] || command apt update"
apt-get update && apt-get install -y bsdmainutils   # column
apt-get update && apt-get install -y coreutils      # tail
apt-get update && apt-get install -y dnsutils       # dig
apt-get update && apt-get install -y expect
apt-get update && apt-get install -y htop
apt-get update && apt-get install -y iftop
apt-get update && apt-get install -y iproute2       # tc
apt-get update && apt-get install -y lsof
apt-get update && apt-get install -y mailutils      # mailx
apt-get update && apt-get install -y net-tools      # netstat
apt-get update && apt-get install -y nmap
apt-get update && apt-get install -y openssh-client # ssh
apt-get update && apt-get install -y parted
apt-get update && apt-get install -y perl
apt-get update && apt-get install -y procps         # ps
apt-get update && apt-get install -y psmisc         # fuser
apt-get update && apt-get install -y smartmontools
apt-get update && apt-get install -y tcpdump
apt-get update && apt-get install -y telnet
apt-get update && apt-get install -y traceroute
apt-get update && apt-get install -y tree
apt-get update && apt-get install -y unzip
apt-get update && apt-get install -y util-linux     # fdisk
apt-get update && apt-get install -y vim
apt-get update && apt-get install -y wget
apt-get update && apt-get install -y whois
apt-get update && apt-get install -y zip
apt-get clean && rm -rf /var/lib/apt/lists/*

# for installing tmux
sudo yum install -y libevent-devel ncurses-devel && cd /usr/local/src && sudo wget https://github.com/tmux/tmux/releases/download/3.2a/tmux-3.2a.tar.gz && sudo tar xfz tmux-3.2a.tar.gz && cd tmux-3.2a && ./configure && sudo make && sudo make install

# lsof このファイルをどのプロセスが使っているか
lsof /bin/bash
# lsof -i このポートをどのプロセスが使っているか
lsof -i tcp:8080
# lsof -t プロセス ID だけ出す
kill "$(lsof -t -i tcp:8080)"

: "Visual Studio Code.app のプロセスをすべて KILL する" && pgrep -fl "Visual Studio Code.app" && pkill -KILL -f "Visual Studio Code.app"

# tcpdump
sudo tcpdump -G300 -W1 -vvv -l -n -p -s 65535 -w "${HOSTNAME}_%Y%m%dT%H%M%S.pcap"
tshark -r "${HOSTNAME}_%Y%m%dT%H%M%S.pcap"

# nm
nm /usr/lib/libcrypto.*

# apt まとめてインストールするためのコマンドを生成する。
curl -LRsS https://ginokent.github.io/bash/ | grep "^apt-get update && apt-get install -y " | awk "\$0=\$7" | tr "\n" " " | sed "s/^/apt-get update \&\& apt-get install -y /; s/ $//"

# du : ルートディレクトリより 1 階層掘って使用量を出力する。
du -h -d 1 --exclude=/proc /

# ps STAT 列に書いてあることの意味
man ps
# PROCESS STATE CODES
#        Here are the different values that the s, stat and state output specifiers (header "STAT" or "S") will display to describe the state of a process:
#
#                D    uninterruptible sleep (usually IO)
#                R    running or runnable (on run queue)
#                S    interruptible sleep (waiting for an event to complete)
#                T    stopped by job control signal
#                t    stopped by debugger during the tracing
#                W    paging (not valid since the 2.6.xx kernel)
#                X    dead (should never be seen)
#                Z    defunct ("zombie") process, terminated but not reaped by its parent
#
#        For BSD formats and when the stat keyword is used, additional characters may be displayed:
#
#                <    high-priority (not nice to other users)
#                N    low-priority (nice to other users)
#                L    has pages locked into memory (for real-time and custom IO)
#                s    is a session leader
#                l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)
#                +    is in the foreground process group

# ps.sh : ps コマンドの代わり。
ps_sh() { _piddirs=$(find /proc -maxdepth 1 -type d -name "[0-9]*"); printf "UID\tPID\tPPID\tCMD\n"; echo "$_piddirs" | sed s@/proc/@@ | while read -r PID; do if [ -d "/proc/$PID" ]; then printf "%s\t%d\t%d\t%s\n" "$(stat -c "%U" "/proc/$PID")" "$PID" "$(cut -d" " -f4 "/proc/$PID/stat")" "$(cat -e "/proc/$PID/cmdline" | sed "s/\^@$//; s/\^@/ /g")"; fi; done; } && ps_sh

# waits : waits 5 . done
waits() { _i=0 && while [ "$1" -gt "$_i" ]; do sleep 1 && if [ "$#" -ge 2 ]; then printf "%s" "${2:-}"; fi && _i=$((_i + 1)); done && echo "${3:-}"; }

# healthcheck
healthcheck() { curl -o /dev/null -w "| url=${1:?} code=%{http_code} exit=" -fLRs "${1:?}" && echo $? || echo $?; }; export -f healthcheck; while sleep 1; do echo "$(date +%FT%T) $(healthcheck https://google.com) $(healthcheck https://github.com)"; done

# alias : Linux 用よく使う alias 詰め合わせ。
alias rm='rm -i'; alias cp='cp -i'; alias mv='mv -i'; alias ls='ls --color=auto'; alias ll='ls -alF';

# nmcli
nmcli c mod ens0 ipv4.method manual ipv4.addresses 10.0.0.1/24 ipv4.gateway 10.0.0.254 ipv4.dns 10.0.0.254,8.8.8.8,1.1.1.1 ipv4.dns-search ginokent.localdomain

# CoreOS で tc コマンドを使う。
# ref. tc コマンドでネットワーク遅延やパケットロスを疑似的に発生させるメモ - ようへいの日々精進XP https://inokara.hateblo.jp/entry/2016/02/14/191853
toolbox
apt-get update && apt-get install -y iproute2
tc qdisc show   dev eth0
tc qdisc add    dev eth0 root netem delay 100ms
tc qdisc change dev eth0 root netem delay 200ms
tc qdisc del    dev eth0 root
tc qdisc add    dev eth0 root netem loss 5%
tc qdisc change dev eth0 root netem loss 10%
tc qdisc del    dev eth0 root

# GCE Ubuntu ディスク拡張
sudo lsblk && sudo apt update -qqy && sudo apt install -qqy cloud-guest-utils && sudo growpart /dev/sda 1 && sudo resize2fs /dev/sda1 && sudo lsblk


# ==================================================
# Mac
# ==================================================

# xcode XCode
xcode-select --install
sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

# 侍エンジニア塾 (sejuku.net) への通信をすべて REJECT する cf. https://www.dragonflybsd.org/~aggelos/pf/ja/filter.html
sudo pfctl -s rules               # 現在の設定を確認
sudo tee -a /etc/pf.conf <<"EOF"  # REJECT する
# REJECT sejuku.net
table <deny_sejuku> const { sejuku.net, corp.sejuku.net, lms.sejuku.net, lp.sejuku.net, www.sejuku.net }
block return out from any to <deny_sejuku>
EOF
sudo pfctl -nf /etc/pf.conf       # 設定ファイルに問題がないか dry-run 読み込み
sudo pfctl -f /etc/pf.conf        # 設定ファイルから読み込み
sudo pfctl -s rules               # 設定を確認
sudo pfctl -E                     # パケットフィルターを有効にする

# dotnet-install.sh https://docs.microsoft.com/ja-jp/dotnet/core/tools/dotnet-install-script
curl -LRSs https://dot.net/v1/dotnet-install.sh | bash
# dotnet-core-uninstall
wget -c https://github.com/dotnet/cli-lab/releases/latest/download/dotnet-core-uninstall.tar.gz -O /tmp/dotnet-core-uninstall.tar.gz ; mkdir -p ~/dotnet-core-uninstall ; tar -zxf /tmp/dotnet-core-uninstall.tar.gz -C ~/dotnet-core-uninstall ; cd ~/dotnet-core-uninstall ; ./dotnet-core-uninstall -h
# dotnet uninstall : dotnet --list-sdks
sudo bash -cx "rm -v -rf /usr/local/share/dotnet/sdk/${version:?} /usr/local/share/dotnet/shared/Microsoft.NETCore.App/${version:?} /usr/local/share/dotnet/shared/Microsoft.AspNetCore.All/${version:?} /usr/local/share/dotnet/shared/Microsoft.AspNetCore.App/${version:?} /usr/local/share/dotnet/host/fxr/${version:?}"
# mono uninstall  ref. https://www.mono-project.com/docs/about-mono/supported-platforms/macos/#uninstalling-mono-on-macos
sudo bash -cx "rm -v -rf /Library/Frameworks/Mono.framework; pkgutil --forget com.xamarin.mono-MDK.pkg; sudo rm /etc/paths.d/mono-commands"
#
ln -sf "$(find /usr/local/Cellar/mono/[0-9].[0-9]* -maxdepth 0 | sort -V | tail -n 1)" /usr/local/Cellar/mono/latest

# k9s : kubectl の TUI https://github.com/derailed/k9s
brew install derailed/k9s/k9s

# mac Mac / brew
brew install bash bash-completion coreutils make

# sslscan https://github.com/rbsec/sslscan
brew install sslscan
sslscan --no-fallback --no-renegotiation --no-compression --no-heartbleed --no-ciphersuites --no-groups example.com

# mac Mac で DNS キャッシュクリア
sudo killall -HUP mDNSResponder

# mac Mac のホスト名変更
scutil --get ComputerName ; scutil --get LocalHostName ; scutil --get HostName
scutil --set ComputerName "${Hostname:?}"; scutil --set LocalHostName "${Hostname:?}"

# Audio Driver
ls -l /Library/Audio/Plug-Ins/HAL

# iCloud
ln -s ~/Library/Mobile*Documents/com~apple~CloudDocs ~/iCloud

: "スクリーンショットの命名を変更する" && defaults write com.apple.screencapture name screenshot

: "ag .git 配下等も検索対象にする" && ag --hidden "my_regex_pattern"

: "mitmproxy の Web UI" && mitmweb --web-host 127.0.0.1 --web-port 43210 --web-open-browser --listen-host 0.0.0.0 --listen-port 4321 --mode reverse:http://0.0.0.0:8000



# ==================================================
# android Android
# ==================================================
# Windows : %LOCALAPPDATA%\JetBrains\Toolbox\apps\AndroidStudio
#   macOS : ~/Library/Application\ Support/JetBrains/Toolbox/apps/AndroidStudio
#   Linux : ~/.local/share/JetBrains/Toolbox/apps/AndroidStudio

# flutter doctor で以下の様にコケたら、
#  |[!] Android toolchain - develop for Android devices (Android SDK version 32.1.0-rc1)
#  |    ✗ cmdline-tools component is missing
#  |      Run `path/to/sdkmanager --install "cmdline-tools;latest"`
#  |      See https://developer.android.com/studio/command-line for more details.
#  |    ✗ Android license status unknown.
#  |      Run `flutter doctor --android-licenses` to accept the SDK licenses.
#  |      See https://flutter.dev/docs/get-started/install/macos#android-setup for more details.
# 以下からコマンドラインをインストールし、
#   Preferences > Appearance & Behavior > System Settings > Android SDK > [x] Android SDK Command-line Tools (latest)
# 以下で JAVA_HOME を通す。
# shellcheck disable=SC2155
export JAVA_HOME="$(find "$HOME/Library/Application Support/JetBrains/Toolbox/apps/AndroidStudio" -type d -name Home | sort -V | tail -n 1 || true)" && echo "${JAVA_HOME:-}"

flutter run --dart-define="DEBUG=true"  ## Visual Studio Code では Cmd+P から  > Debug: Attach to Flutter on Device  で Flutter にアタッチする


# ==================================================
# mysql MySQL
# ==================================================

# performance tuning パフォーマンスチューニング
# 日々の覚書: MySQLのperformance_schemaでどれくらいの情報が見られるのか / https://yoku0825.blogspot.com/2015/03/mysqlperformanceschema.html

# mysql MYSQL_PWD 環境変数を用いて認証を警告無しで通す
MYSQL_PWD="${MYSQL_PWD:?}" mysql --user="${MYSQL_USER:?}" --host="${MYSQL_HOST:?}" -e "SELECT VERSION();";

# mysql 死活監視
while sleep 1; do MYSQL_PWD="${MYSQL_PWD:?}" mysql -u "${MYSQL_USER:?}" -h "${MYSQL_HOST:?}" -e "SELECT '$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+0900) alive'" -BN ; done

# mysqldump : 指定した DATABASE を backup する。 Unknown table 'COLUMN_STATISTICS' in information_schema (1109) が出たらオプション --skip-column-statistics を付ける
mysqldump --routines --hex-blob --single-transaction --set-gtid-purged=OFF --default-character-set=utf8mb4 --host="${MYSQL_HOST:?}" --port="${MYSQL_PORT:?}" --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --databases "${MYSQL_DB:?}" "${MYSQL_DB_2:?}" | gzip - >"${MYSQL_HOST:?}_${MYSQL_DB:?}.dump.gz"
zcat "${MYSQL_HOST:?}_${MYSQL_DB:?}.dump.gz" | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" "${MYSQL_DB:?}"
# mysqldump : 全 DATABASE を backup する。 Unknown table 'COLUMN_STATISTICS' in information_schema (1109) が出たらオプション --skip-column-statistics を付ける
mysqldump --routines --hex-blob --single-transaction --set-gtid-purged=OFF --default-character-set=utf8mb4 --host="${MYSQL_HOST:?}" --port="${MYSQL_PORT:?}" --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}" --all-databases | gzip - >"${MYSQL_HOST:?}_all.dump.gz"
zcat "${MYSQL_HOST:?}_all.dump.gz" | mysql --user="${MYSQL_USER:?}" --password="${MYSQL_PWD:?}"

# mysql ユーザを追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY '${MYSQL_PWD:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' IDENTIFIED BY PASSWORD '${MYSQL_PWD_HASH:?}' WITH GRANT OPTION;"

# mysql ユーザーの権限を表示する
mysql -e "SHOW GRANTS;"
mysql -e "SHOW GRANTS FOR '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql ユーザーの権限を追加する
mysql -e "GRANT ALL PRIVILEGES ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE ON '${MYSQL_DB:?}'.'${TABLE:?}' TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}' WITH GRANT OPTION;"
mysql -e "GRANT ALL ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
mysql -e "GRANT FILE ON *.* TO '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:-192.168.0.0/255.255.0.0}';"
# mysql ユーザーの権限を削除する
mysql -e "REVOKE FILE ON *.* FROM '${MYSQL_USER2:?}'@'${MYSQL_USER2_HOST:?}';"
# mysql 権限テーブルをリロードする
mysql -e "FLUSH PRIVILEGES;"

mysql -e "SELECT host,user,password,plugin FROM mysql.user; -- mysql ユーザー一覧を表示する"
mysql -e "SHOW VARIABLES LIKE 'innodb_print_all_deadlocks'; -- mysql innodb status log を出力する設定を確認する"
mysql -e "SELECT * FROM sys.innodb_lock_waits; -- mysql lock LOCK ロック"
mysql -e "SELECT * FROM information_schema.INNODB_LOCKS; -- mysql lock LOCK ロックの状態を確認する"
mysql -e "SELECT trx_id, trx_state, trx_started FROM information_schema.INNODB_TRX; -- mysql transaction トランザクションの状態を確認する"
mysql -e "SHOW STATUS LIKE 'Threads_connected'; -- mysql connection 現在のコネクション数を表示する"
mysql -e "SHOW PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SHOW FULL PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST WHERE INFO LIKE 'SELECT%' ORDER BY TIME ASC; -- mysql connection 現在のコネクション一覧を表示する"
mysql -e "SELECT * FROM information_schema.PROCESSLIST WHERE time >= 10 AND user NOT IN ('cloudsqlreplica', 'rdsadmin'); -- mysql connection 10 秒以上経過しているコネクションを表示する"
mysql -e "SELECT GROUP_CONCAT(id) FROM information_schema.PROCESSLIST WHERE time >= 10 AND user NOT IN ('cloudsqlreplica', 'rdsadmin'); -- mysql connection 10 秒以上経過しているコネクションを表示する"
mysql -e "KILL ${MYSQL_CONNECTION_ID:?}; -- mysql 接続を殺す"
mysql -e "SHOW STATUS LIKE 'Conn%'; -- mysql 起動してからの累計接続数を表示する"
mysql -e "SHOW GLOBAL VARIABLES LIKE 'innodb_read_only'; -- mysql Master か Replica か判定 (Master は OFF, Replica は ON)"
mysql -e "SELECT @@global.tx_isolation, @@session.tx_isolation; -- mysql transaction isolation level トランザクション分離レベル"
mysql -e "SHOW GLOBAL VARIABLES LIKE 'tx_isolation'; -- mysql transaction isolation level トランザクション分離レベル"
mysql -e "SHOW SESSION VARIABLES LIKE 'tx_isolation'; -- mysql transaction isolation level トランザクション分離レベル"

# mysql create database データベースを作成する
mysql -e "CREATE DATABASE testdb DEFAULT CHARACTER SET utf8mb4;"
mysql -e "CREATE TABLE testdb.testtable (id int NOT NULL PRIMARY KEY, name varchar(10) NOT NULL) ENGINE=InnoDB DEFAULT CHARACTER SET utf8mb4;"
# mysql 使用するデータベースを指定する
mysql -e "USE ${MYSQL_DB:?};"
# mysql データベース一覧を表示する
mysql -e "SHOW DATABASES;"
# mysql データベース詳細を表示する
mysql -e "SHOW CREATE DATABASE ${MYSQL_DB:?}\G"

# mysql table テーブル一覧を表示する
mysql -e "SHOW TABLES;"
# mysql table テーブル詳細を表示する
mysql -e "DESCRIBE ${TABLE:?};"
mysql -e "DESC ${TABLE:?};"
mysql -e "SHOW COLUMNS FROM ${TABLE:?};"
mysql -e "SHOW CREATE TABLE ${TABLE:?}\G"

# mysql index
mysql -e "SHOW INDEX FROM ${TABLE:?}"

# mysql Oracle で言うところの UPSERT. INSERTする時にユニークキーを含まないと複数行ヒットしてしまい、しかし内1行しか更新されないらしい（伝聞）
mysql -e "INSERT INTO ${TABLE:?} (__uniquekey__, __column1__) VALUES ('myAwesomeUniqueKey', 'myAwesomeValue') ON DUPLICATE KEY UPDATE __column1__ = 'myGreatValue', __column2__ = 100;"
mysql -e "SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; INSERT INTO employees VALUES (10000, '1970-01-01', 'John', 'Due', 'M', '2000-01-01') ON DUPLICATE KEY UPDATE hire_date = UTC_TIMESTAMP(); SELECT * FROM employees LIMIT 3; DELETE FROM employees WHERE emp_no = 10000;"

# mysql db database データベースのサイズを表示する
mysql -e "SELECT table_schema, SUM(data_length+index_length)/1024/1024 AS MiB FROM information_schema.tables GROUP BY table_schema ORDER BY SUM(data_length+index_length) DESC;"

# mysql table テーブルのサイズを表示する
mysql -e "SELECT table_name, engine, table_rows, avg_row_length, FLOOR((data_length+index_length)/1024/1024) AS AllMiB, FLOOR((data_length)/1024/1024) AS DataMiB, FLOOR((index_length)/1024/1024) AS IndexMiB FROM information_schema.tables WHERE table_schema=DATABASE() ORDER BY (data_length+index_length) DESC;"

# mysql table の row 数を表示する
mysql -e "SELECT table_name, table_rows FROM information_schema.TABLES WHERE table_schema = '${MYSQL_DB:?}';"

# mysql INNODB STATUS を表示する
mysql -e "SHOW ENGINE INNODB STATUS;"

# mysql ~/.my.cnf の設定
tee -a "${MY_CNF:-"$HOME/.my.cnf"}" << MY_CNF
[client]
user                        = ${MYSQL_USER:?}
host                        = ${MYSQL_HOST:?}
port                        = 3306
password                    = ${MYSQL_PWD:?}
database                    = ${MYSQL_DB:?}
loose-default-character-set = utf8mb4
init_command                = 'SET NAMES utf8mb4;'
MY_CNF

# mysql : サンプルデータベース
curl -LRsS http://downloads.mysql.com/docs/world.sql.gz | gunzip - | mysql
git clone --depth=1 https://github.com/datacharmer/test_db.git /tmp/test_db && cd /tmp/test_db && mysql <./employees.sql

# gcloud cloud sql slow log : rows_examined = このクエリ実行時に何行に触ったか。当然、数字が大きいとマズい。 : https://blog.kamipo.net/entry/2018/03/22/084126
# メモ
# - IN 句に大量に指定いれると PK 絞り込みが効かなくなることがある
PYTHONIOENCODING=UTF-8 gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" logging read 'resource.type="cloudsql_database" AND logName="projects/'"${GOOGLE_CLOUD_PROJECT:?}"'/logs/cloudsql.googleapis.com%2Fmysql-slow.log" AND timestamp>="2021-01-01T00:00:00+09:00" AND timestamp<"2021-01-01T00:01:00+09:00"' --order="asc" --format="value(textPayload)"



# ==================================================
# spanner
# ==================================================
# https://cloud.google.com/spanner/docs/introspection/query-statistics?hl=ja#list_the_queries_that_have_failed_in_a_given_time_period
: "特定の期間内に失敗したクエリを一覧表示する" && spanner-cli -p "${GOOGLE_CLOUD_PROJECT}" -i "${SPANNER_INSTANCE_ID}" -d "${SPANNER_DATABASE}" -e 'SELECT text, request_tag, interval_end, execution_count, all_failed_execution_count, all_failed_avg_latency_seconds, avg_latency_seconds, avg_rows, avg_bytes, avg_rows_scanned, avg_cpu_seconds FROM SPANNER_SYS.QUERY_STATS_TOP_10MINUTE WHERE all_failed_execution_count > 0 ORDER BY interval_end \G'
: "特定の期間内に失敗したクエリを一覧表示する" && gcloud --project "${GOOGLE_CLOUD_PROJECT}" spanner databases execute-sql "${SPANNER_DATABASE}" --instance "${SPANNER_INSTANCE_ID}" --sql 'SELECT text, request_tag, interval_end, execution_count, all_failed_execution_count, all_failed_avg_latency_seconds, avg_latency_seconds, avg_rows, avg_bytes, avg_rows_scanned, avg_cpu_seconds FROM SPANNER_SYS.QUERY_STATS_TOP_10MINUTE WHERE all_failed_execution_count > 0 ORDER BY interval_end'



# ==================================================
# docker Docker
# ==================================================

# docker login
gcloud auth configure-docker
gcloud auth configure-docker asia-docker.pkg.dev --quiet
aws --region "${AWS_REGION:?}" ecr get-login-password | docker login --username AWS --password-stdin https://"${ECR_REPO:?}"

# docker : よく使いそうな docker image たち
: "docker 作業用コンテナ" && docker run -it --rm debian:12 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl procps psmisc sudo >/dev/null 2>&1 & bash"
: "docker 作業用コンテナ" && docker run -it --rm debian:11 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl procps psmisc sudo >/dev/null 2>&1 & bash"
: "docker 作業用コンテナ" && docker run -it --rm ubuntu:22.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl procps psmisc sudo >/dev/null 2>&1 & bash"
: "docker 作業用コンテナ" && docker run -it --rm ubuntu:20.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl procps psmisc sudo >/dev/null 2>&1 & bash"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" alpine sh
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:11 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:10 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:9  bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" debian:8  bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:22.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:20.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:18.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:16.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" ubuntu:14.04 bash -c "apt-get update -qqy && DEBIAN_FRONTEND=noninteractive apt-get install -qqy ca-certificates curl psmisc sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:8 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:7 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" centos:6 bash -c "yum install -y ca-certificates curl sudo; bash -l"
docker run -it --rm -v "$PWD":"$PWD" -w "$PWD" rockylinux/rockylinux:8 bash -c "yum install -y curl sudo; bash -l"

# docker ubuntu:22.04 の docker コンテナを起動する。
docker run -dit --rm --name ubuntu2204 -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.vimrc:/root/.vimrc" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$PWD:$PWD" --workdir "$PWD" ubuntu:22.04 bash && docker exec -it ubuntu2204 bash

# docker 今いる Git リポジトリをボリュームとしてマウントし docker コンテナを起動する。
docker run -dit --rm --name ubuntu2204 -v "$HOME/.ssh:/root/.ssh:ro" -v "$HOME/.vimrc:/root/.vimrc" -v "$HOME/.gitconfig:/root/.gitconfig" -v "$(git rev-parse --show-toplevel):$(git rev-parse --show-toplevel)" --workdir "$PWD" ubuntu:22.04 bash && docker exec -it ubuntu2204 bash

# docker : docker --cap-add=SYS_ADMIN と /sys/fs/cgroup の例。極めて強い権限のため取り扱い注意。
docker run -it --rm --cap-add=SYS_ADMIN -v /sys/fs/cgroup:/sys/fs/cgroup:ro debian:10.2 bash

# docker env
docker run -it --rm -v "$(pwd -P)":"$(pwd -P)" -w "$(pwd -P)" --env-file <(env) alpine sh

# plantuml Plant UML
docker run -d --rm -p 8931:8080 plantuml/plantuml-server:jetty

# docker : nginx NGINX
docker run -i --rm -p 8080:80 nginx
docker run -i -v "$(pwd -P)/nginx.conf":/etc/nginx/nginx.conf:ro -p 8080:80 nginx

# docker : MySQL Server のコンテナを起動する。
export MYSQL_DSN="root:password@tcp(127.0.0.1:3306)/testdb"
docker run -di --rm --name mysql_8_1 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=testdb mysql:8.1
docker run -di --rm --name mysql_8_0 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=testdb mysql:8.0
docker run -di --rm --name mysql_5_7 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=testdb mysql:5.7
docker run -di --rm --name mysql_5_6 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=testdb mysql:5.6
mysql -h 127.0.0.1 -P 3306 -u root --password=password

# docker : PostgreSQL Server のコンテナを起動する。
docker run -di --rm --name postgres_16 -p 5432:5432 -e POSTGRES_PASSWORD=password -e POSTGRES_DB=testdb postgres:16
docker run -di --rm --name postgres_15 -p 5432:5432 -e POSTGRES_PASSWORD=password -e POSTGRES_DB=testdb postgres:15
docker run -di --rm --name postgres_11 -p 5432:5432 -e POSTGRES_PASSWORD=password -e POSTGRES_DB=testdb postgres:11
docker run -di --rm --name postgres_9  -p 5432:5432 -e POSTGRES_PASSWORD=password -e POSTGRES_DB=testdb postgres:9.6
PGPASSWORD=password psql -h 127.0.0.1 -U postgres testdb
PGPASSWORD=password pg_dump -h 127.0.0.1 -U postgres -t 'public.test_table' --schema-only testdb

# docker cockroachdb https://hub.docker.com/r/cockroachdb/cockroach
docker run -di --rm --name cockroachdb_v22 -p 26257:26257 -e COCKROACH_USER=root -e COCKROACH_PASSWORD=password -e COCKROACH_DATABASE=testdb cockroachdb/cockroach:latest-v22.2 start-single-node --http-addr=0.0.0.0:8080 --insecure
docker run -di --rm --name cockroachdb_v23 -p 26257:26257 -e COCKROACH_USER=root -e COCKROACH_PASSWORD=password -e COCKROACH_DATABASE=testdb cockroachdb/cockroach:latest-v23.1 start-single-node --http-addr=0.0.0.0:8080 --insecure
: "CockroachDB に psql で接続" && PGPASSWORD=password psql -h 127.0.0.1 -p 26257 -U root testdb

# docker : Redis Server のコンテナを起動する。
docker run -di --rm --name redis_5_0 -p 6379:6379 redis:5.0
docker run -di --rm --name redis_4_0 -p 6379:6379 redis:4.0
docker run -di --rm --name redis_3_2 -p 6379:6379 redis:3.2
docker run -di --rm --name redis_2_8 -p 6379:6379 redis:2.8
redis-cli -h 127.0.0.1 -p 6379

# nats
docker run -it --rm -p 4222:4222 -p 8222:8222 -p 6222:6222 nats:2.5-alpine


# docker : ビルド時に作成された不要な中間イメージを掃除する。
docker image ls --filter "dangling=true" -aq | xargs docker image rm

# docker : 全部 kill して rm する。掃除する。
{ docker ps -aq | xargs docker kill; docker ps -aq | xargs docker rm; }
{ docker container prune -f; docker volume prune -f; docker image prune -f; docker system prune -f; }

# docker : docker を root ユーザー以外でも実行できるように。
sudo usermod -aG docker "$(whoami)"

# docker : Docker for Windows を WSL1 から利用できるようにするための設定。
command -v docker.exe 1>/dev/null && export DOCKER_HOST=tcp://localhost:2375

screen ~/Library/Containers/com.docker.docker/Data/vms/0/tty                         # docker for mac Docker for Mac の LinuxKit VM の tty に接続する。 2021-07-01 使えなくなってた。
docker run -it --rm --privileged --pid=host debian nsenter -t 1 -m -u -i -n -p -F sh # docker for mac Docker for Mac の LinuxKit VM の中に sh でログインする。
docker run -it --rm --privileged --pid=host justincormack/nsenter1                   # docker for mac Docker for Mac の LinuxKit VM の中に sh でログインする。
tail -n 100 -f ~/Library/Containers/com.docker.docker/Data/log/vm/docker.log         # docker for mac Docker for Mac の docker.log
tail -n 100 -f ~/Library/Containers/com.docker.docker/Data/log/vm/dockerd.log        # docker for mac Docker for Mac の dockerd.log

# docker-compose : 最新の docker-compose をインストールする。
sudo curl -LRsS "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/bin/docker-compose && sudo chmod +x /usr/bin/docker-compose

# docker-compose : `ERROR: readlink /var/lib/docker/overlay2: invalid argument` が出た時に実行する。
docker-compose down --rmi local
docker-compose down --rmi all

# api コンテナから db コンテナに MySQL 接続する。
docker-compose exec api bash -c 'mysql -h db -P 3306 -u root --password=password'

# docker build
curl -Ss https://github.com/hashicorp/terraform/releases/ | grep -Eo "releases/tag/v[0-9]+\.[0-9]+\.[0-9]+" | awk -F "releases/tag/v" "\$0=\$2" | tee /dev/stderr | while read -r VERSION; do printf "%s\n%s\n%s\n%s\n" "FROM hashicorp/terraform:${VERSION}" "RUN apk add --no-cache bash" "ENTRYPOINT []" "CMD terraform" | docker build -t "ginokent/terraform:${VERSION}" - && docker push "ginokent/terraform:${VERSION}"; done



# ==================================================
# Kubernetes
# ==================================================
kubectl get events --sort-by=.metadata.creationTimestamp
kubectl get nodes -o wide
kubectl get nodes -o json | jq -c 'paths|join(".")'
kubectl get pods -o wide
kubectl get pods -o json | jq -c 'paths|join(".")'
kubectl config current-context  # ~/.kube/config が向いている context を表示する
kubectl config get-contexts  # ~/.kube/config が向いている context を表示する
kubectl rollout restart deployment.apps "${DEPLOYMENT_NAME:?}"  # Deplyment の Pod 再起動
kubectl rollout status deployment.apps "${DEPLOYMENT_NAME:?}"  # Deplyment の rollout 状況の確認 wait コマンドに近い
kubectl rollout undo deployment.apps "${DEPLOYMENT_NAME:?}"  # 前のバージョンの Deplyment に切り戻し
kubectl --context="${KUBECTL_CONTEXT:?}" port-forward "service/${SERVICE_NAME:?}" "${LOCAL_PORT:?}:${SERVICE_PORT:?}"
kubectl -n kube-system get deployments
kubectl -n kube-system get --no-headers pods
kubectl -n kube-system edit serviceaccounts aws-load-balancer-controller
kubectl -n kube-system logs "$(kubectl -n kube-system get --no-headers pods -o name -l app.kubernetes.io/name=aws-load-balancer-controller)" -f
kubectl exec -n kube-system "$(kubectl -n kube-system get --no-headers pods -o name | grep -E "aws-node-[0-9A-Za-z]+" | tail -n 1)" -c aws-node -- env | grep AWS
kubectl -n kube-system rollout restart daemonset aws-node

kubectl delete node lima-rancher-desktop
#kubectl -n kube-system delete deployment.apps/metrics-server deployment.apps/local-path-provisioner deployment.apps/coredns deployment.apps/traefik daemonset.apps/svclb-traefik

# kubetail regex
kubetail "^app-[0-9a-z]+-[0-9a-z]+" --regex --context "${KUBECTL_CONTEXT:?}" --namespace default --since 300s

# kubetail + pv 秒間何行ログ出力があるか表示する
kubetail "^app-[0-9a-z]+-[0-9a-z]+" --regex --context "${KUBECTL_CONTEXT:?}" --namespace default --since 300s 2>&1 | pv --line-mode --rate >/dev/null

# k9s を docker 経由で実行する
alias k9s='docker run --rm -it -v ${KUBECONFIG:-~/.kube/config}:/root/.kube/config:ro quay.io/derailed/k9s'



# ==================================================
# AWS aws Amazon Web Services
# ==================================================
# pass : Linux 上での aws-vault の動作要件
sudo apt-get install -y pass
# shellcheck disable=SC2155
export GPG_TTY="$(tty)"
pass init "${EMAIL:?}"

# gpg
gpg --expert --full-generate-key
read -p Name-Real: -r NAMEREAL && read -p Name-Email: -r NAMEEMAIL && read -p Passphrase: -s -r PASSPHRASE && echo && printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n" Key-Type:RSA Key-Length:4096 Key-Usage:cert Subkey-Type:RSA Subkey-Length:4096 Subkey-Usage:encrypt,sign,auth Name-Real:"${NAMEREAL:?}" Name-Email:"${NAMEEMAIL:?}" Expire-Date:0 Passphrase:"${PASSPHRASE:?}" | gpg --expert --full-generate-key --batch -
read -p Passphrase: -s -r PASSPHRASE && echo && gpg --symmetric --batch TARGET_FILE --passphrase "${PASSPHRASE:?}"
read -p Passphrase: -s -r PASSPHRASE && echo && gpg --decrypt --batch ENCRYPTED_FILE --passphrase "${PASSPHRASE:?}"
gpg --with-keygrip --list-keys
gpg --with-keygrip --list-secret-keys
ls -ld ~/.gnupg/private-keys-v1.d/*
gpg --armor --export --output "${KEY_ID:?}.gpg" "${KEY_ID:?}"
gpg --armor --export-secret-keys --output "${SECRET_KEY_ID:?}.secret.gpg" "${SECRET_KEY_ID:?}"

# aws-valut add 資格情報の登録
aws-vault add "${AWS_PROFILE:?}"

# aws-vault exec : aws sts UserId Account Arn を取得する
aws-vault exec "${AWS_PROFILE:?}" -- aws sts get-caller-identity

# MFA を矯正する IAM ポリシーを作成
# cf. https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/tutorial_users-self-manage-mfa-and-creds.html
# cf. https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_examples_aws_my-sec-creds-self-manage.html
aws iam create-policy --policy-name ForceMFA --policy-document https://ginokent.github.io/bash/aws/iam/policy/ForceMFA.json

# wasabi storage
aws --profile wasabi --endpoint-url=https://s3.ap-northeast-1.wasabisys.com s3 ls

# aws ec2 describe-instances (with tags) インスタンス一覧 タグ名
aws --region ap-northeast-1 ec2 describe-instances | jq -rc '.Reservations[].Instances[]|[.InstanceId,(.Tags[]|select(.Key=="Name").Value)]'
aws --region ap-northeast-1 ec2 describe-instances | jq -rc '.Reservations[].Instances[]|[.InstanceId,(.Tags[]|select(.Key=="eks:cluster-name").Value),(.Tags[]|select(.Key=="eks:nodegroup-name").Value)]|@tsv'

aws ec2 describe-instances --filters "Name=tag:Name,Values=${NAME_TAG:?}" --query "Reservations[].Instances[].InstanceId" --output text  # Name タグに一致するインスタンスの ID
aws ssm start-session --target "$(aws ec2 describe-instances --filters "Name=tag:Name,Values=${NAME_TAG:?}" --query "Reservations[].Instances[].InstanceId" --output text)"  # Name タグに一致するインスタンスに SSM で接続

# aws cloudfront
aws cloudfront list-distributions | jq -r '.DistributionList.Items[]|select(.Aliases.Items|any(.=="'"${DOMAIN:?}"'"))|.Id'

# To install the Session Manager plugin using the bundled installer (macOS) https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html#install-plugin-macos
curl -#fLR "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "/tmp/sessionmanager-bundle.zip" && unzip -o -d /tmp /tmp/sessionmanager-bundle.zip && sudo /tmp/sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin

# aws ecs execute-command
aws-vault exec "${AWS_PROFILE:?}" -- aws ecs execute-command --cluster "${ECS_CLUSTER:?}" --task "${ECS_TASK:?}" --container "${CONTAINER_NAME:?}" --interactive --command "/bin/bash"



# ==================================================
# GCP gcp gcloud Google Cloud Platform
# ==================================================

# gcloud 各種コンポーネントをアップデートする。
gcloud components update

# gcloud TL;DR
gcloud config configurations create "${GCP_CONFIG:?}"
gcloud auth login --no-launch-browser
gcloud config set project "${GOOGLE_CLOUD_PROJECT:?}"
gcloud config configurations list
# gcloud 初期化
gcloud init --console-only
# gcloud 現在利用している configuration の内容を表示する。
gcloud config list
# gcloud configuration 一覧を表示する。
gcloud config configurations list
# gcloud configuration を新規作成する ( 初期状態では 'default' が使用される )
gcloud config configurations create "${GCP_CONFIG:?}"
# gcloud アカウントを設定する。
gcloud config set account "${GCP_ACCOUNT:?}"
# gcloud auth login : ログインする
gcloud auth login --no-launch-browser
: "ログインし Cloud SDK のデフォルトの認証情報として利用する" && gcloud auth application-default login && export GOOGLE_APPLICATION_CREDENTIALS=~/.config/gcloud/application_default_credentials.json
# gcloud auth revoke : ログアウトする
gcloud auth revoke
# gcloud --impersonate-service-account auth print-access-token 死んでもクレデンシャルファイルは発行するな
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud --impersonate-service-account="${SERVICEACCOUNT_NAME:?}@${GOOGLE_CLOUD_PROJECT:?}.iam.gserviceaccount.com" auth print-access-token)
: "id_token を表示" && gcloud auth print-identity-token
# gcloud auth activate-service-account : サービスアカウントを用いて認証する
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" auth activate-service-account "${GCP_SERVICE_ACCOUNT}" --key-file "${GOOGLE_APPLICATION_CREDENTIALS:?}"
# gcloud config set project : プロジェクトを設定する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config set project "${GOOGLE_CLOUD_PROJECT:?}"
# gcloud config configurations activate : 利用する configuration を切り替える。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config configurations activate "${GCP_CONFIG:?}"
# gcloud config configurations activate : peco で選択可能形式で configuration を切り替える。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" config configurations activate "$(gcloud config configurations list | tail -n +2 | peco | awk '$0=$1')"
# gcloud compute instances list : 構築順にソート
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute instances list --format="json" | jq -r "sort_by(.creationTimestamp)|.[]|[.creationTimestamp,.name]|@tsv"
# gcloud compute ssh
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute ssh --tunnel-through-iap --zone "${GCP_ZONE:?}" "${GCE_INSTANCE:?}"
ssh -o ProxyCommand="gcloud compute start-iap-tunnel %h %p --listen-on-stdin --zone ${GCP_ZONE:?} --project ${GOOGLE_CLOUD_PROJECT:?}" -l user "${GCE_INSTANCE:?}"
# gcloud compute ssh portforward
ssh -F /dev/null -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand="bash -cx \"gcloud --project ${GOOGLE_CLOUD_PROJECT:?} compute ssh --zone ${GCE_ZONE:?} --tunnel-through-iap %r@%h -- -t -N -L ${LOCAL_PORT:?}:${REMOTE_HOST:?}:${REMOTE_PORT:?}\"" -l "${SSH_USER:?}" "${GCE_INSTANCE:?}"
# gcloud compute config-ssh
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute config-ssh --ssh-config-file=~/.ssh/"${GOOGLE_CLOUD_PROJECT:?}"
# gcloud compute firewall-rules create
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute firewall-rules create "ssh-via-iap" --description="allow SSH vis IAP" --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:22 --source-ranges="35.235.240.0/20" --target-tags="ssh-via-iap"
# gcloud compute instances create terraform
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute instances create "terraform" --zone="${GCP_ZONE:?}" --machine-type="e2-highcpu-2" --network-interface="network-tier=PREMIUM,subnet=default" --maintenance-policy=MIGRATE --service-account="terraform@${GOOGLE_CLOUD_PROJECT:?}.iam.gserviceaccount.com" --scopes="https://www.googleapis.com/auth/cloud-platform" --tags="ssh-via-iap" --create-disk="auto-delete=yes,boot=yes,device-name=terraform,image=projects/ubuntu-os-cloud/global/images/$(gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute images list --filter="family=ubuntu-2004-lts" --format="value(name)"),mode=rw,size=20,type=projects/${GOOGLE_CLOUD_PROJECT:?}/zones/${GCP_ZONE:?}/diskTypes/pd-balanced" --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
# gcloud start-iap-tunnel portforward
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute start-iap-tunnel --zone "${GCP_ZONE:?}" "${GCE_INSTANCE:?}" 22 --local-host-port=localhost:25252
# gcloud 変な operations が起こっていないか確認する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP --project "${GOOGLE_CLOUD_PROJECT:?}"
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP | grep -i hostError
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" compute operations list --sort-by=TIMESTAMP | grep -i err
# gcloud endpoints quota list 割り当て確認
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" alpha endpoints quota list
# gcloud kubernetes cluster を作成する。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters create "${GKE_CLUSTER:?}"
# gcloud kubectl コマンドの設定ファイル ~/.kube/config を指定したクラスターのもので更新する。
# gcloud `Unable to connect to the server: x509: certificate signed by unknown authority` が出た時に使う。
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters get-credentials --zone "${GKE_REGION_OR_ZONE:?}" "${GKE_CLUSTER:?}"
gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" container clusters get-credentials --region "${GKE_REGION_OR_ZONE:?}" "${GKE_CLUSTER:?}"
# gcloud logging read
PYTHONIOENCODING=UTF-8 gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" logging read '(resource.labels.container_name="AAA" OR resource.labels.container_name="BBB") AND "foobar" AND timestamp>="2021-06-15T00:00:00+09:00" AND timestamp<"2021-06-15T23:59:59+09:00"' --order="asc" --format="value(textPayload)"
PYTHONIOENCODING=UTF-8 gcloud --project "${GOOGLE_CLOUD_PROJECT:?}" logging read --format json "timestamp>=\"$(TZ=UTC python3 -c 'import datetime; print((datetime.datetime.now() + datetime.timedelta(days=-10)).strftime("%FT%T"));')\" AND resource.type=\"gce_instance\" AND log_name=~\"projects/[^/]*/logs/cloudaudit.googleapis.com%2Fsystem_event\" AND protoPayload.methodName=\"compute.instances.preempted\"" | jq -c .[]
# gcloud gsutil GOOGLE_APPLICATION_CREDENTIALS サービスアカウントの権限確認のために google/cloud-sdk を利用する。
TEST_KEY=/path/to/key.json ; docker run -it -e GOOGLE_APPLICATION_CREDENTIALS="${TEST_KEY:?}" -v "${TEST_KEY:?}:${TEST_KEY:?}:ro" google/cloud-sdk sh -cx "gcloud auth activate-service-account --key-file ${GOOGLE_APPLICATION_CREDENTIALS:?} && bash -l"
# gcloud metadata.google.internal
curl -H Metadata-Flavor:Google http://metadata.google.internal/computeMetadata/v1/instance/
curl -H Metadata-Flavor:Google http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/email

# gsutil .boto ファイルを生成する
gsutil config -n

# gsutil cache-control GCS メタデータに cache-control: no-store を設定する
# https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Cache-Control#cacheability
gsutil -m setmeta -h "cache-control: no-store" -r "gs://${BUCKET:?}/${PATH_TO:?}"

# gcloud services enable プロジェクトで利用できるサービスを有効化
gcloud services enable run.googleapis.com



# ==================================================
# terraform Terraform
# ==================================================
find . -name "*.go" -exec grep -El "^import [\(\"]" {} \+ | sed "s|/[^/]*$||" | sort -u | xargs -t -P 10 -I {} bash -c "cd {} && go get -u" || true && go mod tidy
terraform fmt -recursive .
find . -name "*.tf" -exec grep -El "^terraform { *(#.*)?" {} \+ | sed "s|/[^/]*$||" | sort -u | xargs -t -P 10 -I {} bash -c "cd {} && terraform init"
find . -name "*.tf" -exec grep -El "^terraform { *(#.*)?" {} \+ | sed "s|/[^/]*$||" | sort -u | xargs -t -P 10 -I {} bash -c "cd {} && terraform validate"



# ==================================================
# VMware ESXi
# ==================================================

/Applications/"VMware OVF Tool"/ovftool --noSSLVerify --datastore="${ESXI_DATASTORE:?}" "vi://${ESXI_USER:?}:${ESXI_PASS:?}@${ESXI_HOST:?}/${ESXI_VM_PATH_WITH_RESOURCE_POOL:?}" "$HOME/Desktop/${OVF_NAME:?}.ova"



# ==================================================
# CircleCI
# ==================================================

# circleci : local で CircleCI を実行する。
circleci local execute



# ==================================================
# Unity
# ==================================================

# unity download urls
curl -LsS https://unity3d.com/get-unity/download/archive | grep -Eo "href=\"unityhub://[^\"]+\"" | sed "s|^.*\"unityhub://\([^/]*\)/\([^\"]*\)\".*$|https://download.unity3d.com/download_unity/\2/UnitySetup-\1|"
# unity check ProjectSettings/ProjectVersion.txt
find "${PWD:?}" -name "ProjectVersion.txt" -print -exec cat {} \;



# ==================================================
# Hugo
# ==================================================
hugo new site . -f yml  # カレントディレクトリをルートとして新しく Hugo サイトを作成
git submodule add https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod --depth=1 && ( cd themes/PaperMod && git checkout v5.0 ) && echo 'theme: "PaperMod"' >> config.yml  # Hugo テーマ themes/PaperMod を追加
hugo new posts/20210926a.md  # 新しい記事を作成
hugo server -D  # draft の記事を含めてサーバーを起動する



# ==================================================
# vim
# ==================================================

# vim ${hoge} を ${hoge:?} に変換する。
# vim %s/\(\${[^!:{}\[\]]*[^\?"]\)}/\1:?}/gc  # 古
# vim %s/\(\${[^!:{}/-]*[^\?"-]\)}/\1:?}/gc   # 新



# ==================================================
# awk gawk
# ==================================================
printf '%d\n%d\n' 1 2               | awk '{sum+=$1} END {print sum}'
printf '%s\n%s\n' 'value1' 'value2' | awk '{ if (/^value2$/) print }'
printf '%s\n'     'before'          | awk '{ gsub(/before/, "\"after\""); print }'
printf '%s\n'     'value1,value2'   | awk '{ split($0, array, ","); print array[1] }'
printf '%s\n'     'abcdefghijklmn'  | awk '{ print toupper($0)}'
printf '%s\n'     'abcdefghijklmn'  | awk '{ print length($0)}'
printf '%s\n%s\n' 1 2               | awk '{print "'"$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+09:00)"'",$0}'
while :; do top -b -c -d 1 -n 1 -o "%CPU" -w 512 | awk '{print "'"$(TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S+09:00)"'",$0}'; sleep 30; done > ~/"${HOSTNAME:?}_top_$(TZ=Asia/Tokyo date +%Y%m%dT%H%M%SJST).log"



# ====================================================================================================
#   ここまで
# ====================================================================================================

# (C) 2018 ginokent </code></pre>
