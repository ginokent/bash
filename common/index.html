#!/usr/bin/env bash
cat >/dev/null << '#newtstat.github.io/bash'
<link rel="icon" href="/favicon.ico" type="image/x-icon"><style>body{font-size:0;margin:0}code,pre{font-size:1rem;font-family:'Ricty Diminished',Osaka-Mono,Menlo,Monaco,Consolas,'Courier New','Andale Mono','Ubuntu Mono',monospace}</style><pre><code>##
#newtstat.github.io/bash
##

# export for func
[ "${LOG_COLOR:-}" = false ] || export enablecolor=true
export  pipe_debug="awk \"{print \\\"${enablecolor:+\\\\033[0;34m}\$(date +%Y-%m-%dT%H:%M:%S%z) [ debug] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"
export   pipe_info="awk \"{print \\\"${enablecolor:+\\\\033[0;32m}\$(date +%Y-%m-%dT%H:%M:%S%z) [  info] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"
export pipe_notice="awk \"{print \\\"${enablecolor:+\\\\033[0;36m}\$(date +%Y-%m-%dT%H:%M:%S%z) [notice] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"
export   pipe_warn="awk \"{print \\\"${enablecolor:+\\\\033[0;33m}\$(date +%Y-%m-%dT%H:%M:%S%z) [  warn] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"
export  pipe_error="awk \"{print \\\"${enablecolor:+\\\\033[0;31m}\$(date +%Y-%m-%dT%H:%M:%S%z) [ error] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"
export   pipe_crit="awk \"{print \\\"${enablecolor:+\\\\033[1;31m}\$(date +%Y-%m-%dT%H:%M:%S%z) [  crit] \\\"\\\$0\\\"${enablecolor:+\\\\033[0m}\\\"}\" /dev/stdin"

# func
export severity="${LOG_SEVERITY:--1}"
Debugln  () { [ "${severity:--1}" -gt 100 ] 2>/dev/null || echo "$*" | bash -c "${pipe_debug:?}"  1>&2; } && export -f Debugln
Infoln   () { [ "${severity:--1}" -gt 200 ] 2>/dev/null || echo "$*" | bash -c "${pipe_info:?}"   1>&2; } && export -f Infoln
Noticeln () { [ "${severity:--1}" -gt 300 ] 2>/dev/null || echo "$*" | bash -c "${pipe_notice:?}" 1>&2; } && export -f Noticeln
Warnln   () { [ "${severity:--1}" -gt 400 ] 2>/dev/null || echo "$*" | bash -c "${pipe_warn:?}"   1>&2; } && export -f Warnln
Errorln  () { [ "${severity:--1}" -gt 500 ] 2>/dev/null || echo "$*" | bash -c "${pipe_error:?}"  1>&2; } && export -f Errorln
Critln   () { [ "${severity:--1}" -gt 600 ] 2>/dev/null || echo "$*" | bash -c "${pipe_crit:?}"   1>&2; } && export -f Critln
Run      () { Infoln "$ $(for a in "$@"; do if echo "$a" | grep -Eq "[[:blank:]]"; then printf "'%s' " "$a"; else printf "%s " "$a"; fi; done | sed "s/ $//")"; "$@"; } && export -f Run

Trap     () { trap -- "${1:?};$(trap -p "${2:?}" | sed "s/trap -- '\(.*\)' ${2:?}/\1/; s/'\\\''/'/g")" "${2:?}"; } && export -f Trap
Catch    () { err=$?; RecWarning "exit ${err-}"; return ${err-}; } && export -f Catch && Trap Catch ERR
CdScriptDir () { cd "$(dirname -- "$0")" || { Errorln "failed to cd $(dirname -- "$0")"; return 1; }; } && export -f CdScriptDir
CommandNotFound () { ! command -v "${1:?"CommandNotFound: \$1 as command is required"}" >/dev/null; } && export -f CommandNotFound
ErrorIfCommandNotFound () { for cmd in "$@"; do if CommandNotFound "${cmd:?}"; then Errorln "command \"${cmd:?}\" is required"; return 1; fi; done; } && export -f ErrorIfCommandNotFound
ConfirmYesOrNo () { echo -n "${1:?}"; read -r YES_OR_NO; echo "${YES_OR_NO-N}" | grep -Eq "^Y|^y"; } && export -f ConfirmYesOrNo  # NOTE: HowToUse: if ConfirmYesOrNo "overwrite? [y/N]: "; then do_something; fi

# MIT License Copyright (c) 2021 newtstat https://github.com/newtstat/rec.sh
_recRFC3339() { date "+%FT%T%z" | sed "s/\(..\)$/:\1/"; }
_recEscape() { printf %s "${1:-}" | sed "s/\"/\\\"/g; s/\r/\\\r/g; s/\t/\\\t/g; s/$/\\\n/g" | tr -d "[:cntrl:]" | sed "s/\\\n$/\n/"; }
_recJSON() { _svr="${1:?}" _msg="$(_recEscape "${2:-}")" && shift 2 && unset _fld _val && for a in "$@"; do if [ "${_val:-}" ]; then _fld="${_fld:?}:\"$(_recEscape "${a:-}")\"" && unset _val && continue; fi && _fld="${_fld:-}${_fld:+,}\"${a:?}\"" _val=1; done && [ $(($# % 2)) = 0 ] || _fld="${_fld:?}:\"\"" && printf "{%s}\n" "\"${REC_TIMESTAMP_KEY:=timestamp}\":\"$(_recRFC3339)\",\"${REC_SEVERITY_KEY:=severity}\":\"${_svr:?}\",\"${REC_CALLER_KEY:=caller}\":\"$0\",\"${REC_MESSAGE_KEY:=message}\":\"${_msg:?}\"${_fld:+,}${_fld:-}"; }
_recCmd() { for a in "$@"; do if echo "${a:-}" | grep -Eq "[[:blank:]]"; then printf "'%s' " "${a:-}"; else printf "%s " "${a:-}"; fi; done | sed "s/ $//"; }
RecDefault() { test "${REC_SEVERITY:-0}" -gt 000 2>/dev/null || _recJSON DEFAULT "$@" 1>&2; }
RecDebug() { test "${REC_SEVERITY:-0}" -gt 100 2>/dev/null || _recJSON DEBUG "$@" 1>&2; }
RecInfo() { test "${REC_SEVERITY:-0}" -gt 200 2>/dev/null || _recJSON INFO "$@" 1>&2; }
RecNotice() { test "${REC_SEVERITY:-0}" -gt 300 2>/dev/null || _recJSON NOTICE "$@" 1>&2; }
RecWarning() { test "${REC_SEVERITY:-0}" -gt 400 2>/dev/null || _recJSON WARNING "$@" 1>&2; }
RecError() { test "${REC_SEVERITY:-0}" -gt 500 2>/dev/null || _recJSON ERROR "$@" 1>&2; }
RecCritical() { test "${REC_SEVERITY:-0}" -gt 600 2>/dev/null || _recJSON CRITICAL "$@" 1>&2; }
RecAlert() { test "${REC_SEVERITY:-0}" -gt 700 2>/dev/null || _recJSON ALERT "$@" 1>&2; }
RecEmergency() { test "${REC_SEVERITY:-0}" -gt 800 2>/dev/null || _recJSON EMERGENCY "$@" 1>&2; }
RecExec() { RecInfo "$ $(_recCmd "$@")" && "$@"; }
RecRun() { _dlm='####R#E#C#D#E#L#I#M#I#T#E#R####' _all=$({ _out=$("$@") && _rtn=$? || _rtn=$? && printf "\n%s" "${_dlm:?}${_out:-}" && return ${_rtn:-0}; } 2>&1) && _rtn=$? || _rtn=$? && _dlmno=$(echo "${_all:-}" | sed -n "/${_dlm:?}/=") && _cmd=$(_recCmd "$@") && _stdout=$(echo "${_all:-}" | tail -n +"${_dlmno:-1}" | sed "s/^${_dlm:?}//") && _stderr=$(echo "${_all:-}" | head -n "${_dlmno:-1}" | grep -v "^${_dlm:?}") && RecInfo "$ ${_cmd:-}" command "${_cmd:-}" stdout "${_stdout:-}" stderr "${_stderr:-}" return "${_rtn:-0}" && return ${_rtn:-0}; }

# CPUアーキテクチャ判定用
export EnvIsAMD64=false

# カーネル判定用
export EnvIsDarwin=false
export EnvIsLinux=false

# Ubuntu
export EnvIsUbuntu=false
export EnvIsUbuntu1404=false
export EnvIsUbuntu1604=false
export EnvIsUbuntu1804=false
export EnvIsUbuntu2004=false

# Amazon Linux
export EnvIsAmazonLinux=false
export EnvIsAmazonLinux2=false

# CentOS
export EnvIsCentOS=false
export EnvIsCentOS6=false
export EnvIsCentOS7=false
export EnvIsCentOS8=false

# Rocky Linux
export EnvIsRockyLinux=false
export EnvIsRockyLinux8=false

# CPU アーキテクチャ判定
if uname -m | grep -q ^x86_64$; then
  EnvIsAMD64=true
fi

# カーネル判定
if uname -s | grep -q ^Darwin$; then
  EnvIsDarwin=true
elif uname -s | grep -q ^Linux$; then
  EnvIsLinux=true
fi

# ディストリビューション及び OS バージョン判定
if grep -q "\"Ubuntu 14\.04.* LTS\"" /etc/lsb-release 2>/dev/null; then
  EnvIsUbuntu=true
  EnvIsUbuntu1404=true
elif grep -q "\"Ubuntu 16\.04.* LTS\"" /etc/lsb-release 2>/dev/null; then
  EnvIsUbuntu=true
  EnvIsUbuntu1604=true
elif grep -q "\"Ubuntu 18\.04.* LTS\"" /etc/lsb-release 2>/dev/null; then
  EnvIsUbuntu=true
  EnvIsUbuntu1804=true
elif grep -q "\"Ubuntu 20\.04.* LTS\"" /etc/lsb-release 2>/dev/null; then
  EnvIsUbuntu=true
  EnvIsUbuntu2004=true
elif grep -q "\"Ubuntu .* LTS\"" /etc/lsb-release 2>/dev/null; then
  EnvIsUbuntu=true
elif grep -q "\"Amazon Linux 2\"" /etc/lsb-release 2>/dev/null; then
  EnvIsAmazonLinux=true
  EnvIsAmazonLinux2=true
elif grep -q "^CentOS release 6\." /etc/centos-release 2>/dev/null; then
  EnvIsCentOS=true
  EnvIsCentOS6=true
elif grep -q "^CentOS Linux release 7\." /etc/centos-release 2>/dev/null; then
  EnvIsCentOS=true
  EnvIsCentOS7=true
elif grep -q "^CentOS Linux release 8\." /etc/centos-release 2>/dev/null; then
  EnvIsCentOS=true
  EnvIsCentOS8=true
elif grep -q "CentOS" /etc/centos-release 2>/dev/null; then
  EnvIsCentOS=true
elif grep -q "\"Rocky Linux 8.*\"" /etc/os-release 2>/dev/null; then
  EnvIsRockyLinux=true
  EnvIsRockyLinux8=true
elif grep -q "\"Rocky Linux.*\"" /etc/os-release 2>/dev/null; then
  EnvIsRockyLinux=true
fi

# 読み込み判定用
export EnvIsLoaded=true

# ログ出力
RecInfo "environment variables" env="$(env | grep ^EnvIs | sort | tr "\n" "," | sed "s/,\([^ ]\)/, \1/g; s/,$//")"



# (C) 2018 newtstat </code></pre>
